<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>db.Postgres</title>
    <link rel="icon" href="https://sempernow.github.io/refpages/sa/favicon.png">
    <link rel="stylesheet" href="https://sempernow.github.io/refpages/sa/css/normalize.css">
    <link rel="stylesheet" href="https://sempernow.github.io/refpages/sa/css/main.css">
    <!--
    <link rel="stylesheet" href="https://sempernow.github.io/refpages/sa/css/dev.css">
    -->
    <link rel="stylesheet" href="https://sempernow.github.io/refpages/sa/css/hljs.github.min.css">
    <style>

    </style>
    <script src="https://sempernow.github.io/refpages/sa/js/hl.min.js"></script>
    <script>hljs.highlightAll()</script>
</head>
<body>
    <main>
        <h1><a href="https://www.postgresql.org/docs/10/index.html" title="postgresql.org/docs">PostgreSQL</a> | <a href="https://www.youtube.com/watch?v=KK0YPraAYTo" title="'PostgreSQL Top Ten Features' @ YouTube 2016">Features</a> | <a href="https://hub.docker.com/_/postgres" title="hub.docker.com :: postgres">@ Docker</a> | <a href="https://wiki.postgresql.org/wiki/Main_Page" title="PostgreSQL Wiki">Wiki</a> |  <a href="https://en.wikipedia.org/wiki/PostgreSQL">Wikipedia</a></h1>

<ul>
<li>Distributed, ACID-compliant, transactional RDBMS,<br>
using Multiversion concurrency control (MVCC)</li>
<li>Highly Extensible</li>
<li>Materialized Views (Updatable)</li>
<li>Triggers</li>
<li>Foreign keys</li>
<li>Functions &amp; Stored Procedures; embed other languages<br></li>
</ul>

<h2><a href="https://postgresqlco.nf/doc/en/param/" title="@ postgresqlco.nf">PostgreSQL Server Parameters</a> | <a href="https://postgresqlco.nf/tuning-guide">Tuning Guide</a></h2>

<p>Searchable listing and descriptions of all PostgreSQL server parameters, and tuning guide too!</p>

<h2><code>psql</code> session</h2>

<pre><code class="language-bash">$ psql
</code></pre>

<pre><code class="language-sql">psql (12.7)
postgres=# \q
</code></pre>

<pre><code class="language-bash">$ createuser -P -e user1
$ psql -c &quot;CREATE DATABASE foo&quot;
$ psql -U user1 -d foo
</code></pre>

<pre><code class="language-sql">psql (12.7)
foo=&gt; \du
                                   List of roles
 Role name |                         Attributes                         | Member of
-----------+------------------------------------------------------------+-----------
 user1     |                                                            | {}
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
foo=&gt; \q
</code></pre>

<h2><a href="https://hub.docker.com/_/postgres" title="hub.docker.com :: postgres">PostgreSQL 12+ @ Docker</a></h2>

<ul>
<li>Alpine (<code>postgres:12.7-alpine</code>; <code>160MB</code>)

<ul>
<li><code>~</code> (home)

<ul>
<li>@ <code>/var/lib/postgresql</code></li>
</ul></li>
<li><code>$PGDATA</code> (cluster data directory)

<ul>
<li>@ <code>/var/lib/postgresql/data</code></li>
</ul></li>
</ul></li>
<li>DNS vs (ephemeral) IP address

<ul>
<li><code>listen_addresses=foo</code> fails</li>
<li><code>listen_addresses=foo.bar</code> resolves

<ul>
<li>declare <code>hostname: foo.bar</code> (@ YAML)</li>
</ul></li>
</ul></li>
<li>Initialization (first run) : <code>initdb</code><br>

<ul>
<li>Either <code>POSTGRES_PASSWORD</code> or <code>POSTGRES_PASSWORD_FILE</code> must be set, else aborts.</li>
<li>Can set <code>POSTGRES_USER</code> to any name, but the <strong><em>user must exist</em></strong> @ container's <code>/etc/passwd</code>, else <code>initdb</code> fails. The official <code>postgres</code> image has and can run as <code>postgres:postgres</code> (<code>70:70</code>).</li>

<li><p>No mounts to <code>$PGDATA</code> (on first run, else <code>initdb</code> does nothing); directory must be empty (and sans mounts).</p>

<pre><code class="language-yaml">    user: &quot;postgres&quot;
    command: [&quot;postgres&quot;, &quot;-c&quot;, &quot;config_file=/mnt/host/postgresql.conf&quot;, &quot;-c&quot;, &quot;...&quot;] 
</code></pre>

<p>@ map syntax</p>

<pre><code class="language-yaml">    user: &quot;postgres&quot;
    command:
        - &quot;postgres&quot;
        - &quot;-c&quot;
        - &quot;config_file=/mnt/host/postgresql.conf&quot;
        - &quot;-c&quot;
        - &quot;shared_buffers=3GB&quot;
        - &quot;-c&quot;
        - &quot;listen_addresses=*&quot;
</code></pre></li>
</ul></li>

<li><p>To run as current (OS) user (accepted by <code>initdb</code> as legitimate)</p>

<pre><code class="language-bash">docker run -it --rm --user &quot;$(id -u):$(id -g)&quot; \
    -v /etc/passwd:/etc/passwd:ro \
    -e POSTGRES_PASSWORD=$users_pw \
    $PG_IMAGE
</code></pre>

<ul>
<li>So can fake a <code>passwd</code> file and therefore user?</li>
</ul></li>
</ul>

<h2><a href="https://docs.aws.amazon.com/cli/latest/reference/rds/describe-db-engine-versions.html">@ AWS RDS</a> :: <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html#PostgreSQL.Concepts">Managed RDBMS Engine per AMI Instance</a></h2>

<pre><code class="language-bash"># Versions list
aws rds describe-db-engine-versions \
    --engine 'postgres' \
    | jq -r '.DBEngineVersions[].EngineVersion'
</code></pre>

<ul>
<li><code>9.5.2, ..., 9.6.8-20, 10.9-15, ..., 11.4-10, ..., 12.2-5</code> (2021-02-10)</li>
</ul>

<h2>Architecture</h2>

<p>PostgreSQL uses a client/server model; a session consists of <strong>cooperating processes</strong>:</p>

<ul>
<li><p>Server process (<code>postgres</code>); manages the database files, accepts connections from client applications, and performs database actions on behalf of the clients. (Unix domain socket <code>/tmp/.s.PGSQL.5432</code>)</p></li>

<li><p>Client (frontend) process; application requesting database operations; can be a CLI, GUI, web server, or a specialized database maintenance tool. <a href="https://www.postgresql.org/docs/current/reference-client.html">PostgreSQL <em>native client apps</em></a> include <code>psql</code>, <code>createdb</code>, <code>dropdb</code>, <code>pg_dump</code>, <code>pg_restore</code>; many tools are developed by the community.</p>

<ul>
<li>Some native client tools fail if their <strong>version does not match</strong> that of the server.</li>
</ul></li>

<li><p>Client and the server may be on different hosts, communicating over a TCP/IP network connection. If so, files accessible by client machine might not be accessible on the database server machine, or may be accessible, but only by a different file name.</p></li>

<li><p>PostgreSQL server handles multiple concurrent connections from clients by starting (forking) a new process for each connection, so the master server process is always running, waiting for client connections; whereas client and associated server processes come and go.</p></li>
</ul>

<h2><a href="https://www.postgresql.org/docs/12/ddl.html">Data Definition Language</a> (DDL)</h2>

<h2>Data Types <a href="https://www.postgresql.org/docs/current/datatype.html" title="postgresql.org">@ PostgreSQL</a> | <a href="https://www.w3schools.com/sql/sql_datatypes.asp" title="Canonical SQL @ w3schools.com">@ SQL (Reference)</a> | <a href="https://www.postgresql.org/docs/current/typeconv-overview.html">Extensible types</a></h2>

<h3><a href="https://www.postgresql.org/docs/current/functions-info.html">System Info Functions</a></h3>

<ul>
<li><code>pg_typeof((SELECT foo FROM bar where colx = 'unique'))</code> &mdash; data type</li>
<li><code>current_database()</code></li>
<li><code>current_schema()</code></li>
<li><code>current_user()</code></li>
<li><code>version()</code></li>
<li><code>pg_get_keywords()</code> &mdash; list of all keywords and their restrictions</li>
</ul>

<h4>Pairing types across app boundaries</h4>

<table>
<thead>
<tr>
<th>PostgreSQL</th>
<th>Golang</th>
<th>Javascript</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>BIGINT</code></td>
<td><code>int</code></td>
<td><code>integer</code></td>
</tr>

<tr>
<td><code>UUID</code></td>
<td><code>string</code></td>
<td><code>string</code></td>
</tr>

<tr>
<td><code>NUMERIC(5,2)</code></td>
<td>???</td>
<td>???</td>
</tr>

<tr>
<td><code>TIMESTAMPTZ</code></td>
<td><code>time.Time</code></td>
<td><code>string</code></td>
</tr>
</tbody>
</table>

<ul>
<li><p>@ Golang, currency may be <code>float32</code> or <a href="https://godoc.org/golang.org/x/text/currency#Unit" title="godoc.org"><code>currency.Unit{USD}</code></a></p>

<pre><code class="language-bash">☩ curl -s -X GET localhost:3000/books/create | jq .
{
&quot;id&quot;: &quot;41c27323-09f7-4056-8579-a90cf260febf&quot;,
&quot;title&quot;: &quot;Foo bar&quot;,
&quot;price&quot;: 44.22,
&quot;timeDb&quot;: &quot;2020-06-25T16:01:38.19155Z&quot;,
&quot;timeGo&quot;: &quot;2020-06-25T16:01:38.188344Z&quot;
}
</code></pre></li>

<li><p>Note difference in accuracy; PostgreSQL is only to 10's of <code>ms</code>, whereas Golang, <code>time.Now()</code>, is accurate to the <code>ms</code>.</p></li>
</ul>

<h2>Comments</h2>

<p>Mind the syntax; always only one <code>--</code> per line, and always follow by at least one whitespace before adding text.</p>

<pre><code class="language-sql">-- okay
SELECT foo, bar FROM a -- okay
-- okay
--bad
---bad
-- bad -- bad
WHERE bar = 22;    -- okay
</code></pre>

<ul>
<li>The bad don't always cause problems, but do under certain conditions.</li>
<li>Some wrappers are even more finicky.

<ul>
<li>E.g., no trailing comments (per file) at Adminer when loading by file (<code>Import</code>).</li>
</ul></li>
</ul>

<h2>Types</h2>

<ul>
<li><p>Date/Time <a href="https://www.postgresql.org/docs/current/datatype-datetime.html" title="postgresql.org">Types</a> | <a href="https://www.postgresql.org/docs/current/functions-datetime.html">Functions and Operators</a></p>

<ul>
<li><p><a href="https://wiki.postgresql.org/wiki/Don%27t_Do_This#Date.2FTime_storage">Use <strong><code>timestamptz</code></strong></a>, not <code>timestamp</code>.</p>

<pre><code class="language-sql">CREATE TABLE foo tz TIMESTAMP WITH TIME ZONE;
-- or, using its PostgreSQL alias, ...
CREATE TABLE foo tz TIMESTAMPTZ;
</code></pre></li>

<li><p>Behavior: <a href="https://wiki.postgresql.org/wiki/PostgreSQL_vs_SQL_Standard#TIMESTAMP_WITH_TIME_ZONE" title="wiki.postgresql.org">SQL spec vs PostgreSQL</a></p></li>

<li><p><code>timestamptz</code> stores an integer; microseconds since January 1st, 2000 in UTC, and <em>auto-handles time zone conversions</em>, mapping to server-session timezone on query; access using <code>at time zone</code>. (<code>timestamp</code> does none of that; stores data and time, and will cause problems.)</p>

<pre><code class="language-sql">CREATE TABLE t1 (
    tstamp  TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    date    BIGINT DEFAULT now_unix()
)
-- timestamptz to bigint Unix milliseconds 
-- to match Golang time.Time @ millisecond: (time.Now().UnixNano() / 1e6)
SELECT date,(extract(epoch FROM tstamp)*1000)::BIGINT as tstamp FROM t1;
</code></pre>

<pre><code class="language-plaintext">         date      |    tstamp
    ---------------+---------------
     1593996756642 | 1593996756642
</code></pre>

<pre><code class="language-sql">-- RFC3339 : 2022-01-06T14:49:45Z
SELECT to_char(date_trunc('seconds', now()), 'YYYY-MM-DD&quot;T&quot;HH24:MI:SS&quot;Z&quot;');

-- ADD year, month, day, hour, minute, second
SELECT NOW();
-- 2020-08-04 16:45:02.457971+00
SELECT NOW() + INTERVAL '5 minute';
-- 2020-08-04 16:50:06.368969+00
SELECT NOW() + INTERVAL '1 hour';
-- 2020-08-04 17:45:16.205172+00

-- Get SERVER timezone
SELECT current_setting('TIMEZONE');
-- Set SERVER timezone
SET timezone = 'EST';

-- Use type casting (has a RUNTIME COST)
SELECT NOW()::timestamptz AT TIME ZONE 'Europe/Rome' as &quot;Rome's timestamp&quot;;

--       Rome's timestamp
-- ----------------------------
--  2020-06-16 15:11:45.649728

-- From Timestamp to Epoch (digits) ...
-- FIX flakey-varying per scan issue 
-- Use date_trunc() to SET ACCURACY, ELSE number of decimals VACILLATE. 
SELECT extract(epoch FROM date_trunc('milliseconds', NOW())); -- seconds
-- 1594417154.250
SELECT (extract(epoch FROM date_trunc('milliseconds', now()))*1000);
-- 1594417154250  (13 digits vs &lt;10&gt;.&lt;3&gt;)

SELECT (extract(epoch FROM NOW())*1000)::bigint; -- ms
-- 1594417197766
SELECT extract(epoch FROM timestamptz '2015-07-20 01:00+02');
-- 1437346800
SELECT extract(epoch FROM t1.date_create)::NUMERIC(15,0) FROM t1;
-- 1593867279

-- From Epoch (digits) to TimestampTZ 
SELECT to_timestamp(1437346800)::timestamptz;
-- 2015-07-19 23:00:00+00
SELECT to_timestamp(1437346800)::timestamptz AT TIME ZONE 'Europe/Rome';
-- 2015-07-20 01:00:00

-- From Epoch (digits) to Timestamp 
SELECT to_timestamp( 1437346800);
--  2015-07-19 23:00:00+00 
</code></pre>

<ul>
<li>Set accuracy per <a href="https://www.postgresql.org/docs/9.6/functions-datetime.html"><code>date_trunc('milliseconds', Now())</code></a></li>
</ul>

<p>To ensure the literal is treated as <code>timezonetz</code>, use &hellip;</p>

<pre><code class="language-sql">TIMESTAMP WITH TIME ZONE '2015-07-20 01:00+02'
</code></pre>

<ul>
<li><p><a href="https://www.postgresqltutorial.com/postgresql-timestamp/">Usage/Helpers</a></p>

<pre><code class="language-sql">-- Change server timezone
SET timezone = 'America/New_York';
-- Get timezone 
SHOW TIMEZONE;
-- Get timestamp; specify timezone
SELECT timezone('America/New_York','2016-06-01 00:00');
-- Same but &quot;better&quot;
SELECT timezone('America/New_York','2015-07-19 23:00'::timestamptz);
-- 2015-07-19 19:00:00
SELECT timezone('America/New_York',(SELECT to_timestamp(1437346800))::timestamptz);
-- 2015-07-19 19:00:00
-- Set FORMAT (Precision, etc)
SELECT to_char((SELECT to_timestamp(1437346800)::timestamptz), 'YYYY-MM-DD HH:MI:SS.US TZ');
-- 2015-07-19 11:00:00.000000 UTC
SELECT to_char('2015-07-19 11:00:00.000000'::timestamptz, 'YYYY-MM-DD HH:MI:SS.US TZ');
-- 2015-07-19 11:00:00.000000 UTC
</code></pre></li>
</ul></li>

<li><p>List of <strong><em>Timezone Names</em></strong>; output to a CSV file.</p>

<pre><code class="language-sql">COPY (
SELECT * from pg_timezone_names
) to '/home/timezones.csv' WITH CSV HEADER; 
</code></pre></li>

<li><p>To truncate, <a href="https://wiki.postgresql.org/wiki/Don't_Do_This#Don.27t_use_timestamp.280.29_or_timestamptz.280.29">use <strong><code>date_trunc('second', blah)</code></strong></a></p>

<ul>
<li>Not <code>timestamp(0)</code>, and not <code>timestamptz(0)</code>; they <em>round off</em>, not truncate.</li>
</ul></li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/datatype-numeric.html">Numeric</a></p>

<ul>
<li><code>SMALLINT</code>, <code>INTEGER</code>, <code>BIGINT</code>, <code>DECIMAL</code>, <code>NUMERIC</code>, <code>REAL</code>, <code>DOUBLE PRECISION</code>, <code>SMALL SERIAL</code>, <code>SERIAL</code>, <code>BIGSERIAL</code>.</li>

<li><p><a href="https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-NUMERIC-DECIMAL">NUMERIC</a><a name="serial"></a>; <strong><em>arbitrary precision</em></strong> numbers.</p>

<pre><code class="language-sql">-- precision is total number of digits; scale is that following the decimal point.
NUMERIC(precision [, scale])
-- Money; up to 9.99 Billion
NUMERIC(12,2)
</code></pre></li>

<li><p><a href="https://www.postgresql.org/docs/current/datatype-money.html">Monetary</a></p>

<ul>
<li><a href="https://wiki.postgresql.org/wiki/Don't_Do_This#Don.27t_use_money">Use <strong><code>NUMERIC</code></strong></a> (above), not <code>MONEY</code>, else suffer round-off and other issues.<br></li>
</ul></li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/datatype-character.html">TEXT/CHARACTER</a>; handles <strong><em>up to <code>1 GB</code></em></strong> per; optimizes per length; auto compress/decompress (internally and transparently), and only when apropos.</p>

<ul>
<li><a href="https://wiki.postgresql.org/wiki/Don't_Do_This#Text_storage">Use <strong><code>text</code></strong> or <strong><code>varchar</code></strong></a>, <strong>sans limit</strong> (<strong><code>n</code></strong>); neither <code>char(n)</code> nor  <code>varchar(n)</code>. Else suffer padding (to <code>n</code>) issues mucking with SQL logic.

<ul>
<li><p><strong><em>To limit length</em></strong>, use a <a href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-CHECK-CONSTRAINTS" title="ddl-constraints @ PostgreSQL.org">Check Constraint</a> instead.</p>

<pre><code class="language-sql">-- Name it to clarify the error message(s).
foo TEXT CONSTRAINT max_foo CHECK (LENGTH(foo) &lt;= 512)
</code></pre></li>
</ul></li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/datatype-uuid.html">UUID</a></p>

<ul>
<li>Useful for Primary Key</li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-SERIAL">Serial</a><a name="serial"></a></p>

<ul>
<li>Useful, but <strong><em>depricated</em></strong>, for Primary Key; not standard SQL; not true types (serial, bigserial), but merely a notational convenience for creating unique identifier columns. (See <a href="#primary-keys" title="below">Primary Keys</a>.)</li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/datatype-enum.html" title="postgresql.org">Enumerated</a></p></li>

<li><p><a href="https://www.postgresql.org/docs/current/datatype-net-types.html" title="postgresql.org">Network Address</a></p></li>

<li><p><a href="https://www.postgresql.org/docs/current/datatype-json.html" title="postgresql.org">JSON</a> (<code>json</code>|<code>jsonb</code>) | <a href="https://www.postgresql.org/docs/current/gin.html">GIN Indexes</a> | <a href="https://www.postgresql.org/docs/current/functions-json.html" title="postgresql.org">JSON Functions and Operators</a></p>

<ul>
<li><strong><code>jsonb</code></strong> is the efficient, key-searchable, binary format; slower to input, but <strong>significantly faster to process</strong>; <a href="https://www.postgresql.org/docs/current/datatype-json.html#JSON-INDEXING" title="jsonb indexing">supports (GIN) indexing</a>.<br></li>
<li>Store as JSON (document/<em>denormalized</em>) data type in cases where<br>
storing otherwise would require lots of <code>JOIN</code> ops. And do so in <code>jsonb</code> format, unless processing it as an atomic blob, with insert/retrieve only, sans key/val searches.</li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/arrays.html" title="postgresql.org">Arrays</a></p>

<pre><code class="language-sql">CREATE TABLE sal_emp (
uname       text,
pay_by_qtr  integer[],
sch         text[][],
foo         integer[3][3]
);

INSERT INTO sal_emp (uname, pay_by_qtr, sch)
VALUES (
    'Bill',                                     -- uname
    '{10000, 10000, 10000, 10000}',             -- pay_by_qtr
    '{{&quot;meeting&quot;, &quot;lunch&quot;}, {&quot;presentation&quot;}}'   -- sch
);
</code></pre></li>
</ul>

<h2><a href="https://www.w3schools.com/sql/default.asp" title="tutorial @ www.w3schools.com">SQL</a> | <a href="https://www.postgresql.org/docs/11/sql-commands.html" title="sql-commands [list] @ postresql.org">Commands</a> | <a href="https://www.postgresql.org/docs/current/sql.html" title="sql @ postgresql.org">Language</a> | <a href="https://www.postgresql.org/docs/current/tutorial-sql.html" title="tutorial-sql @ postgresql.org">Tutorial</a></h2>

<h3><a href="https://www.postgresql.org/docs/current/sql-keywords-appendix.html">SQL Keywords</a></h3>

<p>Both &quot;reserved&quot; + &quot;non-reserved&quot; <strong><em>words to avoid</em></strong> as identifiers. E.g., <code>id</code>, <code>name</code>, <code>names</code>, <code>new</code>, <code>nil</code>, <code>none</code>, <code>null</code>, <code>nulls</code>, <code>path</code>, <code>per</code>, <code>ref</code>, <code>row</code>, &hellip;, <code>uri</code>, <code>user</code>, <code>value</code>, <code>view</code>, <code>views</code></p>

<h3>Admin :: <code>CREATE</code>/<code>DROP</code> Database / User <code>GRANT ... PRIVILEGES</code></h3>

<pre><code class="language-sql">-- drop (remove, delete) db
DROP DATABASE 'db_foo';
-- create a db
CREATE DATABASE 'db_foo';
-- create user
CREATE USER 'userof_foo' WITH PASSWORD 'pass_of_userof_foo';
-- grant privileges
GRANT ALL PRIVILEGES ON DATABASE 'db_foo' to 'userof_foo';
-- revoke privileges
REVOKE ALL PRIVILEGES ON DATABASE company from james;

-- alter
ALTER USER james WITH SUPERUSER;
ALTER USER james WITH NOSUPERUSER;
-- remove
DROP USER james;

-- server version
SELECT version();

-- connect to db
\c db_foo
-- list dbs
\l 
-- see current user
SELECT current_user;
-- see current database
SELECT current_database();
</code></pre>

<ul>
<li>@ Client (<code>psql</code>) session</li>
</ul>

<h3>Benchmark :: <a href="https://www.postgresql.org/docs/current/sql-explain.html"><code>EXPLAIN [ANALYZE, ...]</code></a></h3>

<pre><code class="language-sql">EXPLAIN ANALYZE 
    SELECT b.*
    FROM books b 
    WHERE price &lt; 8
    ORDER BY b.title ASC;
</code></pre>

<pre><code class="language-sql">                                                 QUERY PLAN
------------------------------------------------------------------------------------------------------------
 Sort  (cost=25.14..25.64 rows=200 width=108) (actual time=0.017..0.017 rows=2 loops=1)
   Sort Key: title
   Sort Method: quicksort  Memory: 25kB
   -&gt;  Seq Scan on books b  (cost=0.00..17.50 rows=200 width=108) (actual time=0.008..0.010 rows=2 loops=1)
         Filter: (price &lt; '8'::numeric)
         Rows Removed by Filter: 1
 Planning Time: 0.056 ms
 Execution Time: 0.029 ms
(8 rows)
</code></pre>

<h3><a href="https://www.postgresql.org/docs/11/ddl-schemas.html">Create Schema</a></h3>

<ul>
<li>A database contains one or more named schemas, which in turn contain tables. Schemas also contain other kinds of named objects, including data types, functions, and operators.<br>
The same object name can be used in different schemas without conflict. Unlike databases, schemas are not rigidly separated.  <strong>Uses</strong>:<br></li>
<li>To allow many users to use one database without interfering with each other.</li>
<li>To organize database objects into logical groups to make them more manageable.</li>

<li><p>Third-party applications can be put into separate schemas so they do not collide with the names of other objects.</p>

<pre><code class="language-sql">CREATE SCHEMA foo_schema AUTHORIZATION some_user;
CREATE TABLE foo_schema.some_table (
 ...
);
</code></pre></li>
</ul>

<h4><a href="https://www.postgresql.org/docs/current/ddl-schemas.html#DDL-SCHEMAS-PATTERNS" title="@ postgresql.org">Schema : Best Practices</a></h4>

<p>Add/set schema name to user's name. Also run certain <code>REVOKE</code> commands so that any current user's default schema is their user name (instead of default being <code>public</code>).</p>

<pre><code class="language-sql">-- Create schema
CREATE SCHEMA IF NOT EXISTS uzr1;
--SET search_path TO uzr1, public;
ALTER SCHEMA uzr1 OWNER TO CURRENT_USER;

-- Revoke CREATE permission on public schema from PUBLIC role 
REVOKE CREATE ON SCHEMA public FROM PUBLIC;
-- Revoke PUBLIC role’s ability to connect to database
REVOKE ALL ON DATABASE db1 FROM PUBLIC;
</code></pre>

<ul>
<li>Thereby, qualified names are <code>username.tablename</code>, yet <code>tablename</code> resolves to that per default search path.

<ul>
<li>&quot;<em>Constrain ordinary users to user-private schemas. To implement this, issue <code>REVOKE CREATE ON SCHEMA public FROM PUBLIC</code>, and create a schema for each user with the same name as that user. Recall that the default search path starts with <code>$user</code>, which resolves to the user name. Therefore, if each user has a separate schema, they access their own schemas by default.</em>&quot;</li>
</ul></li>

<li><p>Schema; post changeover</p>

<pre><code class="language-sql">db1=# \dt
            List of relations
Schema |       Name        | Type  | Owner
--------+-------------------+-------+-------
public | darwin_migrations | table | uzr1
uzr1   | channels          | table | uzr1
uzr1   | groups            | table | uzr1
uzr1   | messages          | table | uzr1
uzr1   | subscriptions     | table | uzr1
uzr1   | transactions      | table | uzr1
uzr1   | users             | table | uzr1
uzr1   | views             | table | uzr1
</code></pre></li>
</ul>

<h2><a href="https://www.postgresql.org/docs/current/dml.html" title="postgresql.org">Data Manipulation</a> (CRUD)</h2>

<ul>
<li><a href="https://wiki.postgresql.org/wiki/Don't_Do_This#SQL_constructs">Don't use <code>NOT IN</code></a>. <a href="https://wiki.postgresql.org/wiki/Don't_Do_This#Don.27t_use_BETWEEN_.28especially_with_timestamps.29">Don't use <code>BETWEEN</code></a>.<br></li>
<li><a href="https://wiki.postgresql.org/wiki/Don't_Do_This#Don.27t_use_SQL_ASCII">Don't use <code>SQL_ASCII</code> encoding</a>.<br></li>
<li><a href="https://wiki.postgresql.org/wiki/Don't_Do_This#Don.27t_use_upper_case_table_or_column_names">Don't use <em>upper-case</em> table names</a>.<br></li>
</ul>

<h3><a href="https://www.postgresql.org/docs/11/sql-createtable.html">Create Table</a></h3>

<ul>
<li>@ <strong>Table &amp; Column Names</strong>; <a href="https://wiki.postgresql.org/wiki/Don" title="t_Do_This#Don.27t_use_upper_case_table_or_column_names &quot;ALWAYS use lower-case @ PostgreSQL">always use lowercase</a>, because such names are <strong><em>folded to lower-case</em></strong>, regardless, by PostgreSQL; though that is not compliant with the standard SQL spec.

<ul>
<li>Table <code>foos</code> or <code>foos_bars</code>, for example.</li>
</ul></li>
<li>Auto-incrementing, e.g., a primary-key (<code>id</code>)<br>

<ul>
<li><p>Canonical SQL</p>

<pre><code class="language-sql">CREATE TABLE foos (
    id integer NOT NULL AUTO_INCREMENT
);
</code></pre></li>
</ul></li>

<li><p><strong>Primary Key</strong> (PK) <a name="primary-keys"></a> &mdash; &quot;<code>PRIMARY KEY</code>&quot; and&quot;<code>NOT NULL UNIQUE</code>&quot; are <strong><em>equivalent</em></strong>; want to guarantee unique; if use integer <em>sequence</em>, <code>bigint</code> (per <code>IDENTITY</code>; see below), then debugging is easier, but scaling &mdash;sharding a distributed database/table &mdash;has issues; if use <code>uuid</code> (<em>random</em>), then scales well (shards), but debugging can be hell lest some (indexed) table column exists that reckons the (logical, time, or whatever) <em>sequence</em> of its data. Also, for both security and decoupling, don't expose any PK to any client. <strong>Affect on performance</strong>: The index update on INSERT or UPDATE (any write) takes time, so inserting into a UNIQUE indexed table is <em>slower</em> than inserting into one without any unique index or primary key.</p>

<blockquote>
<p>A solution to the security issue is to use two indexed keys; the sequential key, as PK, and a second &quot;external&quot; (client-side) <strong>globally-unique</strong> ID, e.g., <code>uuid</code>. Also see <a href="https://github.com/tvondra/sequential-uuids" title="PostgreSQL extension by Tomas Vondra 2019 @ GitHub">Sequential UUID generator</a>, which is similar to <def title="Comcombined-time GUID">COMB</def>.</p>
</blockquote>

<ul>
<li><p>Summary:</p>

<pre><code class="language-sql">CREATE EXTENSION IF NOT EXISTS &quot;pgcrypto&quot;;                  -- for UUID v4 generator 
CREATE TABLE IF NOT EXISTS messages (
    id  BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,    -- surrogate key (internal)
    msg_id UUID DEFAULT gen_random_uuid(),                  -- natural key  (external)
    ...
);
CREATE INDEX IF NOT EXISTS msg_id_idx ON messages (msg_id); -- fast query on msg_id key.

SELECT left(msg_id::text, 8) FROM messages; -- to truncated string
</code></pre></li>

<li><p>If primary key: <code>id    UUID PRIMARY KEY DEFAULT gen_random_uuid(),</code></p></li>

<li><p>Details:</p></li>

<li><p>PK per <a href="http://www.postgresqltutorial.com/postgresql-identity-column/">Identity</a>; an auto-incrementing numerical type; not globally unique (locally unique), but the PK is fast and <strong><em>sortable</em></strong>.<br>
<code>... GENERATED [ALWAYS|BY DEFAULT] AS IDENTITY [PRIMARY KEY]</code></p>

<ul>
<li><p>Create</p>

<pre><code class="language-sql">CREATE TABLE users (
idx BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
email TEXT NOT NULL
);
</code></pre></li>

<li><p>Insert and query</p>

<pre><code class="language-sql">INSERT INTO users (name) 
VALUES ('abc'), ('xyz');
SELECT * FROM users;
</code></pre>

<pre><code>idx     |    name 
-------------------
1      |     abc
2      |     xyz
</code></pre></li>
</ul></li>

<li><p>PK per <a href="#serial" title="@ Data Types, above">Serial</a>; non-standard SQL; depricated; use Identity method (above) instead.</p>

<pre><code class="language-sql">CREATE TABLE tblname (
    colname SERIAL
);
-- equivalent (standard SQL) ...
CREATE SEQUENCE tblname_colname_seq AS integer;
CREATE TABLE tblname (
    colname INTEGER NOT NULL DEFAULT nextval('tblname_colname_seq')
);
ALTER SEQUENCE tblname_colname_seq OWNED BY tblname.colname;
</code></pre>

<p>Then</p>

<pre><code class="language-sql">ALTER TABLE tblename ADD PRIMARY KEY (colname);
</code></pre></li>

<li><p>PK per <a href="https://www.postgresql.org/docs/current/uuid-ossp.html">UUID</a>; <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_%28random%29" title="Wikipedia">use <code>v4</code></a>; universally unique; random; fast query (is it's own data type in PostgreSQL), but is <strong><em>not sortable</em></strong>; can generate internally per extention.</p>

<ul>
<li><p>per <a href="https://www.postgresql.org/docs/current/pgcrypto.html"><code>pgcrypto</code></a> extension; <a href="https://www.postgresql.org/docs/current/pgcrypto.html#id-1.11.7.34.9"><code>gen_random_uuid()</code></a> &mdash; Generates v4 UUID; the extension/method <a href="https://www.postgresql.org/docs/current/uuid-ossp.html#id-1.11.7.53.6"><em>suggested at PostgreSQL docs</em></a> if only generating v4 (random) UUIDs, else use <code>uuid-ossp</code> extension (below).</p>

<pre><code class="language-sql">-- Load extension
CREATE EXTENSION IF NOT EXISTS &quot;pgcrypto&quot;;
-- Create PK
CREATE TABLE users (
   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
);
</code></pre></li>

<li><p>per <a href="https://www.postgresql.org/docs/current/uuid-ossp.html"><code>uuid-ossp</code></a> extension; <a href="https://www.postgresql.org/docs/current/uuid-ossp.html#id-1.11.7.53.4"><code>uuid_generate_v4()</code></a> &mdash; Generates v4 UUID.</p>

<pre><code class="language-sql">-- Load extension
CREATE EXTENSION IF NOT EXISTS &quot;uuid-ossp&quot;;
-- Create PK
CREATE TABLE users (
   id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
);
</code></pre></li>
</ul></li>

<li><p>PK per <a href="https://github.com/tvondra/sequential-uuids" title="PostgreSQL extension by Tomas Vondra 2019 @ GitHub">Sequential UUID</a></p>

<ul>
<li>Similar to <def title="Comcombined-time GUID">COMB</def>, it combines a locally-unique sequence (either timestamp or serial index) with a globally-unique UUID. <em>Available as</em> <strong><em>PostgreSQL</em></strong> ( <code>v10+</code>) <strong><em>extension</em></strong> .</li>
</ul></li>

<li><p>PK per <a href="https://github.com/oklog/ulid" title="'Universally Unique Lexicographically-Sortable Identifier' @ Golang @ GitHub">ULID</a>; 26 chars (base32); lexicographically sortable (unlike <code>mattersmost/NewID</code>); <em>&quot;compatible with UUID/GUIDs&quot;</em>, but <strong><em>not</em></strong> with PostgreSQL type <code>UUID</code>. Also, unlike <code>UUID</code>, must generate externally, @ (Golang) application.</p></li>

<li><p>PK per <a href="https://github.com/segmentio/ksuid" title="K-Sortable Unique IDentifier @ Golang 2017 @ GitHub">KSUID</a>; &quot;roughly&quot; sortable by time of creation. Generate externally, @ (Golang) application.</p></li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/ddl-constraints.html" title="ddl-constraints @ postgresql.org"><strong>Constraints</strong></a> (<strong><em>Referential Integrity</em></strong>) &mdash; Used to limit the type of data that can go into a table; action abored on fail; ensures the accuracy and reliability of the data in the table. <a href="https://www.w3schools.com/sql/sql_constraints.asp" title="w3schools.com/sql">Common constraints</a>:</p>

<pre><code>NOT NULL    - Ensure column cannot have a NULL value.  
UNIQUE      - Ensure all values in a column are different.  
PRIMARY KEY - Uniquely identifies each row/record in a table;  
              Combination of NOT NULL and UNIQUE.  
FOREIGN KEY - Uniquely identifies a row/record in another table.  
CHECK       - Ensure all values in a column satisfy a specific condition.   
DEFAULT     - Sets a default value for a column when no value is specified.  
INDEX       - Used to create and retrieve data from the database very quickly.  
</code></pre>

<pre><code class="language-sql">-- add constraint 
ALTER TABLE subscriptions ALTER COLUMN usr_id SET NOT NULL;
-- remove constraint 
ALTER TABLE subscriptions ALTER COLUMN usr_id DROP NOT NULL;
</code></pre>

<ul>
<li><p>Some constraints require a <em>declared constraint name</em> to enable any subsequent removal;</p>

<ul>
<li>E.g., <code>ADD CONSTRAINT order_id_fk FOREIGN KEY (order_id) ...</code></li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-CHECK-CONSTRAINTS"><code>CHECK</code> (The inserted data must satisfy a boolean.)</a></p>

<pre><code class="language-sql">CREATE TABLE products (
    product_no integer,
    name text,
    price numeric CHECK (price &gt; 0)
);
</code></pre>

<ul>
<li><p>Optionally name, and may apply to multiple columns.</p>

<pre><code class="language-sql">price numeric CHECK (price &gt; 0),
discounted_price numeric CHECK (discounted_price &gt; 0),
CHECK (price &gt; discounted_price)
</code></pre></li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-FK" title="ddl-constraints @ postgresql.org">Foreign Keys</a> (current; ver <code>11.2</code>.)</p>

<ul>
<li><p><strong>Referencial Integrity</strong>, e.g., forbid entries in one table if no matching entries exist in another table.</p>

<pre><code class="language-sql">-- refererenced table
CREATE TABLE products (
    product_no integer PRIMARY KEY,
    ...
);
-- referencing table
CREATE TABLE orders (
    ...
    product_no integer RENCES products,  
    ...
);
</code></pre>

<ul>
<li>Prohibits creation of an <code>orders</code> entry, unless its <code>product_no</code> exists in the <code>products</code> table. (The <code>product_no</code> is a <strong>foreign key</strong>  in <code>orders</code> table.)</li>
</ul></li>

<li><p>Constrain <strong>a group of columns</strong>:</p>

<pre><code class="language-sql">CREATE TABLE t1 (
    ...
    b integer,
    c integer,
    FOREIGN KEY (b, c) RENCES other_table (c1, c2)
);
</code></pre>

<h4>Summary</h4>

<pre><code class="language-sql">-- M:M @ products:orders

CREATE TABLE products (
product_id BIGINT PRIMARY KEY,
product_name TEXT,
price NUMERIC 
);

CREATE TABLE orders (
order_id BIGINT PRIMARY KEY,
shipping_address TEXT
);

-- resolve (w/ constraints) with junction table
CREATE TABLE products_orders (
product_id BIGINT RENCES products ON DELETE RESTRICT,   -- =&gt;
order_id BIGINT RENCES orders ON DELETE CASCADE,        -- &lt;=
PRIMARY KEY (product_id, order_id)
);
</code></pre></li>
</ul></li>
</ul></li>
</ul>

<h4>Better, two-step method;</h4>

<ol>
<li>Create table(s)</li>

<li><p>Add constraints (Referential Integrity)</p>

<pre><code class="language-sql">-- 1.) Create table
CREATE TABLE products_orders (
product_id BIGINT,
order_id BIGINT
);

-- 2.) Add Constraints (Referential Integrity)
--     Naming each CONSTRAINT allows for subsequent DROP CONSTRAINT &lt;name&gt;;

ALTER TABLE products_orders
ADD CONSTRAINT product_id_fk 
    FOREIGN KEY (product_id) RENCES products(product_id) ON DELETE RESTRICT;

ALTER TABLE products_orders
ADD CONSTRAINT order_id_fk  
    FOREIGN KEY (order_id) RENCES orders(order_id) ON DELETE CASCADE;

ALTER TABLE products_orders
ADD CONSTRAINT products_orders_pk PRIMARY KEY (product_id, order_id);
</code></pre></li>
</ol>

<ul>
<li><p>Always use <strong><em>lower case</em></strong> for all <strong><em>names</em></strong>, everywhere.</p></li>

<li><p><a href="https://www.postgresql.org/docs/current/tutorial-inheritance.html">Inheritance</a></p>

<ul>
<li><a href="https://wiki.postgresql.org/wiki/Don't_Do_This#Don.27t_use_table_inheritance">Don't use table inheritance.</a> Use foreign keys instead.<br></li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/ddl-alter.html#id-1.5.4.7.9" title="ddl-alter @ postgresql.org">Modifying Tables</a> (<code>ALTER TABLE</code>)  &mdash; To <code>ADD</code>, <code>DROP</code> (delete), or <code>MODIFY</code> <strong>columns</strong> in an existing table; <code>ADD</code> or <code>DROP</code> various <strong>constraints</strong> on an existing table; <code>REANAME</code> a table.</p>

<pre><code class="language-sql">ALTER TABLE products ALTER COLUMN price TYPE numeric(10,2);
</code></pre></li>
</ul>

<h3><code>SELECT ... CASE ... LIMIT</code></h3>

<pre><code class="language-sql">...
SELECT *
FROM &quot;vw_messages&quot;
...
ORDER BY 
    CASE WHEN n  &gt; 0 THEN date_create END DESC, -- @ older
    CASE WHEN n &lt;= 0 THEN date_create END ASC   -- @ newer
LIMIT CASE WHEN n &gt; 0 THEN n ELSE -n END;
</code></pre>

<ul>
<li>Sorts <strong><em>once</em></strong> by whichever <code>CASE</code> is <code>true</code> .</li>
</ul>

<h3><a href="https://www.postgresql.org/docs/current/tutorial-populate.html">Insertions</a> <a href="https://www.postgresql.org/docs/current/sql-insert.html">(<code>INSERT</code>)</a> &ndash; Populate a table with values, per table row.</h3>

<h4><code>INSERT ... VALUES (..)</code></h4>

<pre><code class="language-sql">-- Insert a row whereof all columns are set to default values
INSERT INTO products DEFAULT VALUES;
-- Insert a row per data set of declared values; columns IMPLIED
INSERT INTO products VALUES (1, 'Cheese', 9.99);
-- Insert a row per data set of declared values; columns EXPLICITLY declared
INSERT INTO products (name, price, product_no) VALUES ('Cheese', 9.99, 1);
-- Insert SEVERAL ROWS, per explicitly declared columns
INSERT INTO products (product_no, name, price) VALUES
    (1, 'Cheese', 9.99),
    (2, 'Bread', 1.99),
    (3, 'Milk', 2.99);
</code></pre>

<h4><code>INSERT ... SELECT ...</code></h4>

<p>Populate one table (<code>table2</code>) with <strong><em>values from another table</em></strong> (<code>table1</code>), column per column.</p>

<pre><code class="language-sql">INSERT INTO table2 (column1, column2, column3, ...)
    SELECT column1, column2, column3, ...
    FROM table1
    WHERE condition; 
</code></pre>

<p>Static test</p>

<pre><code class="language-sql">INSERT INTO messages (
    to_id, to_handle, chn_id, body, author_id)
SELECT 'toMsgID', 'toAuthorHandle', 'chnID', 'the body', 'authorID'
WHERE CASE
    WHEN 
        'toMsgID' = ''
    THEN 
        'chnID' IN ( SELECT c.chn_id FROM vw_channels c WHERE c.owner_id = 'authorID' )
    ELSE 
        true
    END
LIMIT 1
</code></pre>

<ul>
<li>Replace string literals with parameters suiting the driver; @ Golang: <code>$1</code>, <code>$2</code>, &hellip;</li>
</ul>

<p>More examples &hellip;</p>

<pre><code class="language-sql">-- Insert into tbl_1 values from tbl_2 plus literal(s)
INSERT INTO tbl_1 (
    xid, scope, key_name, key_hash
) -- user_id is field of tbl_2; all else are literals. 
SELECT user_id, xis_user_enum(), 'rand26.rand60', pw_hash('rand26.rand60')
FROM tbl_2
WHERE roles @&gt; ARRAY['HOST']
AND (email LIKE '%@emx.unk')
-- Insert conditionally, including such at other tables (Golang sqlx syntax)
INSERT INTO messages (
    msg_id, to_id, to_display, to_handle, chn_id, 
    author_id, author_display, author_handle, author_avatar, author_badges, 
    title, summary, body, form, privacy, date_create, date_update, sponsub)
SELECT $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18
WHERE CASE -- &lt;&lt;&lt; Insert(s) occur only where CASE evalutes to true, per EXISTS(..).
    WHEN -- new (not reply) message.
        ( $2 )::UUID IS NULL
    THEN -- forbid new message lest author is channel owner, or is auto-generated sponsub message.
        EXISTS (
            SELECT 1
            FROM vw_channels c 
            WHERE c.chn_id = $5
            AND CASE 
                    WHEN $18 &lt;&gt; 0
                    THEN true
                    ELSE c.owner_id = $6
                END
        )
    ELSE -- forbid reply message lest recipient message (rx) exists in channel.
        EXISTS (
            SELECT 1 
            FROM vw_messages rx 
            WHERE rx.msg_id = $2
            AND rx.author_handle = $4
            AND rx.chn_id = $5
        )
    END
LIMIT 1
</code></pre>

<h4>Upsert</h4>

<pre><code class="language-sql">-- ON CONFLICT ... DO UPDATE ...
INSERT INTO geo_cities(
    id, country_id, city_name
)
VALUES (1, 1, 'ExampleName')
ON CONFLICT (id) DO UPDATE SET 
    country_id = excluded.country_id, 
    city_name = excluded.city_name
RETURNING *; -- @ function, must match pre-body statement: RETURNS ... AS
</code></pre>

<pre><code class="language-sql">-- SELECT ... WHERE NOT EXISTS : (Golang example)
INSERT INTO channels (
    chn_id, view_id, owner_id, 
    host, slug, title, about, 
    privacy, msg_size, date_create, etag
    )
SELECT $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11
WHERE NOT EXISTS (SELECT slug FROM channels WHERE slug = $5)
</code></pre>

<pre><code class="language-sql">-- RETURNING : @ Upsert
INSERT INTO applicants (
    email, handle, code, mode, date_create
)
VALUES ('foo@bar.com', 'hsle', '1234567', 1, now())
ON CONFLICT (email) DO UPDATE SET 
    &quot;handle&quot; = 'hsle',
    &quot;code&quot; = '1234567',
    &quot;mode&quot; = 1,
    &quot;date_create&quot; = now()
WHERE applicants.email = 'foo@bar.com'
RETURNING *;          -- Typed return !!!

 idx |    email    | handle |  code   | mode |          date_create
-----+-------------+--------+---------+------+-------------------------------
  10 | foo@bar.com | hsle   | 1234567 |    1 | 2022-02-03 14:53:53.614682+00
(1 row)
-- OR
...
RETURNING applicants; -- Untyped return !!!

                           applicants
-----------------------------------------------------------------
 (10,foo@bar.com,hsle,1234567,1,&quot;2022-02-03 14:55:43.501578+00&quot;)
(1 row)
</code></pre>

<ul>
<li>Double quotes around field names, e.g., <code>&quot;handle&quot;</code>, is not needed here, but PostgreSQL converts all such names to lowercase without them.</li>
</ul>

<h4><code>IN</code> is faster than <code>OR</code></h4>

<pre><code class="language-sql">-- Replace this ...
WHERE (handle = 'app') OR (handle = 'AdminTest') OR (handle = 'UserTest')
--- ... with this ...
WHERE handle IN ('app', 'AdminTest', 'UserTest')
</code></pre>

<pre><code class="language-sql">-- inverse
WHERE slug NOT IN ('pub', 'sub')
</code></pre>

<h4><code>t1.c3 = ANY (..)</code> | t1.c3 IN (..)</h4>

<pre><code class="language-sql">WHERE chn_id = ANY (SELECT chn_id FROM vw_messages WHERE author_id = appid())
-- OR (EQUIVALENT)
WHERE chn_id IN (SELECT chn_id FROM vw_messages WHERE author_id = appid())
</code></pre>

<h4><code>ANY</code> @ Array</h4>

<pre><code class="language-sql">--- Replace this ...
WHERE c.key = ANY (ARRAY[123, 539, ...])
-- ... OR ...
WHERE c.key IN (123, 539, ... )
--- ... with this (performant) ...
WHERE c.key = ANY (VALUES (123), (539), ... )
-- ... OR ...
WHERE c.key IN (VALUES (123), (539), ... )
</code></pre>

<h4>ARRAY contains : <code>@&gt;</code> | <a href="https://www.postgresql.org/docs/12/functions-array.html"><code>ARRAY</code> Functions</a></h4>

<p>Add an element to an <code>ARRAY</code>, e.g., to a field of type <code>TEXT[]</code></p>

<pre><code class="language-sql">-- Idempotent append
UPDATE users SET 
    roles = array_append(roles, 'MODERATOR')
WHERE handle = 'FooBAR' AND NOT roles @&gt; ARRAY['MODERATOR'];
</code></pre>

<h3><code>INSERT... RETURNING &lt;table or column(s) name(s)&gt;</code>, or <code>UPDATE ... RETURNING ...</code>; returns <em>only</em> the rows successfuly inserted; use <strong><em>to validate</em></strong> the mutation &hellip;</h3>

<ul>
<li><p>Yet such is <em>not compatible</em> with Golang's <code>sqlx</code> pkg <code>Exec()</code>, which returns nothing.</p>

<pre><code class="language-sql">INSERT INTO messages_binary (timestamp, group_id, content) VALUES
('1', 'group5', '...'),
('2', 'group6', '...'),
('3', 'group7', '...')
ON CONFLICT DO NOTHING 
RETURNING timestamp;
</code></pre></li>
</ul>

<p><code>RETURNING &lt;table-name&gt;</code>; return ALL table columns, i.e., <strong><em>pointfree</em></strong> style &hellip;</p>

<pre><code class="language-sql">INSERT INTO books (isbn, title, author, price) VALUES
    ('978-1505255607', 'The Time Machine', 'H. G. Wells', 5.99),
    ('978-1503261969', 'Emma', 'Jayne Austen', 9.44)
    RETURNING books;
</code></pre>

<blockquote>
<p>Pointfree makes for cleaner, more legible code, and much less of it. Just be careful to match the two boundaries (db &amp; app); the table columns (db) must align with the destination struct fields (app).</p>
</blockquote>

<h4><a href="https://www.postgresql.org/docs/current/sql-copy.html"><code>COPY ... FROM</code>/<code>TO ...</code></a></h4>

<p>Insert <strong><em>data</em></strong> from/to a <strong><em>file</em></strong> source/target; requires <strong><em>absolute path</em></strong> of the file; process an entire data file in one command; several file formats (<code>TEXT</code>, <code>CSV</code>, or <code>BINARY</code>); less flexible than <code>INSERT</code>, but incurs <strong><em>significantly less overhead for large data loads</em></strong>; <code>BINARY</code> format is the fastest.</p>

<blockquote>
<p>Requires a user having <code>SUPERUSER</code> or <code>pg_write_server_files</code> <code>ROLE</code>, else per script <code>psql ... -f exfiltrate.sql</code></p>
</blockquote>

<ul>
<li><p><code>FROM</code> a <strong><em>tab-delimited</em></strong> plain text file (default format).</p>

<pre><code class="language-sql">-- insert file data into table
COPY products (product_no, name, price) 
    FROM '/home/user/products.txt';
</code></pre></li>

<li><p><code>FROM</code> a <strong><code>CSV</code></strong> file (<em>Preserves whitespace!</em>)</p>

<pre><code class="language-sql">COPY some_table (col3,col7,col2)
FROM '/foo/postgres-data.csv'
DELIMITER ',' CSV HEADER; -- include header ( field names) row
</code></pre></li>

<li><p><code>TO</code> one record (row) to <strong><code>BINARY</code></strong> file or <code>STDOUT</code></p>

<pre><code class="language-sql">COPY (
    SELECT *
    FROM foo WHERE idx=50
) TO STDOUT WITH BINARY;
</code></pre></li>

<li><p><code>TO</code> a <code>CSV</code> file</p>

<pre><code class="language-sql">COPY (
    SELECT msg_id, body
    FROM messages
) TO '/home/foo.csv' WITH CSV; -- sans HEADER (field names) row
</code></pre></li>
</ul>

<h5><a href="https://www.postgresql.org/docs/current/functions-srf.html" title="postgresql.org"><code>generate_series()</code></a> for <a href="https://regilero.github.io/postgresql/english/2017/06/26/postgresql_advanced_generate_series/" title="regilero.github.io/postgresql 2017">data generation</a> | <a href="https://stackoverflow.com/questions/19145761/postgres-for-loop" title="@ StackOverflow.com">Set-based vs <code>FOR LOOP</code></a></h5>

<pre><code class="language-sql">DROP TABLE IF EXISTS foo;
CREATE TABLE IF NOT EXISTS foo (
    idx     INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    c1      INT
);

INSERT INTO foo (c1)  
    SELECT * FROM generate_series(105,109) -- 105, ..., 109
    LIMIT  15000;  -- safety

SELECT * FROM foo;

--  idx | c1
-- -----+-----
--    1 | 105
--    2 | 106
--    3 | 107
--    4 | 108
--    5 | 109
</code></pre>

<h3><a href="https://www.postgresql.org/docs/current/queries.html">Queries</a> <a href="https://www.postgresql.org/docs/current/sql-select.html">(<code>SELECT</code>)</a></h3>

<pre><code class="language-sql">-- expression 
SELECT city, (temp_hi+temp_lo)/2  
    AS temp_avg, date FROM weather;

-- qualify
SELECT * FROM weather
    WHERE city = 'San Francisco' 
    AND prcp &gt; 0.0;

-- unique &amp; sort
SELECT DISTINCT city
    FROM weather
    ORDER BY city;

-- return the first row that matches
SELECT * FROM foo WHERE idx &gt; 3 LIMIT 1;
</code></pre>

<h3><code>UNION</code> [<code>ALL</code>]</h3>

<p>Concatenate tables (having same columns) <strong>per row</strong>.</p>

<pre><code class="language-sql">SELECT * FROM messages where author_name = 'foo'
UNION
SELECT * FROM messages where to_id IS NOT NULL
</code></pre>

<p><code>UNION ALL</code> <strong><em>is faster</em></strong>; sans redundancy check.</p>

<pre><code class="language-sql">SELECT city FROM customers
UNION ALL -- rows may be duplicates
SELECT city FROM suppliers
ORDER BY city;
</code></pre>

<p><code>UNION</code> is also useful per column, e.g., <strong><em>prepend a column</em></strong> to a query result</p>

<pre><code>```sql 
SELECT 'Customer' AS kind, contact_name, city, country
FROM customers
UNION
SELECT 'Supplier', contact_name, city, country
FROM suppliers;

kind        contact_name        city            country
Customer    Yvonne Moncada      Buenos Aires    Argentina 
Customer    Zbyszek             Walla           Poland 
Supplier    Anne Heikkonen      Lappeenranta    Finland 
Supplier    Antonio del Sadra   Oviedo          Spain 
Supplier    Beate Vileid        Sandvika        Norway 
```
</code></pre>

<h3><code>JOIN</code></h3>

<p>Combine tables per common column | <a href="https://www.postgresql.org/docs/current/tutorial-join.html" title="tutorial @ postgresql.org">postgresql.org</a> | <a href="https://www.w3schools.com/sql/sql_join.asp" title="w3schools.com">w3schools.com</a> | <a href="https://www.w3resource.com/sql/joins/sql-joins.php" title="tutorial @w3resource.com">@w3resource.com</a></p>

<p><img src="./../SQL.JOIN-types.png" alt="Join Types"></p>

<ul>
<li><p><code>[INNER] JOIN</code></p>

<pre><code class="language-sql">
-- Explicit syntax
SELECT *
FROM a
INNER JOIN b
ON a.c5 = b.c3
WHERE b.c2 = 'x'

-- Equivalent syntax
SELECT * 
FROM a
JOIN b
ON a.c5 = b.c3
WHERE b.c2 = 'x'

-- Alternative Syntax
SELECT *
FROM a, b
WHERE a.c5 = b.c3
AND b.c2 = 'x'
</code></pre>

<ul>
<li>Output <strong>all columns</strong> from <strong>both tables</strong> as long as the columns match.</li>

<li><p>To select some subset of columns &hellip;</p>

<pre><code class="language-sql">SELECT a.c3, b.c1, a.c7, a.c2
FROM a
JOIN b 
ON a.c5 = b.c3
WHERE b.c2 = 'x'
</code></pre></li>
</ul></li>

<li><p><code>LEFT [OUTER] JOIN</code></p>

<pre><code class="language-sql">SELECT *
    FROM weather 
    LEFT OUTER JOIN cities 
    ON (weather.city = cities.name);
</code></pre>

<ul>
<li>Regards tables left and right of the <strong>join operator</strong>; <strong>all rows</strong> of the <strong>left table</strong> are output <em>at least once</em>, whereas <strong>only matching rows</strong> of the <strong>right table</strong> are output.</li>
</ul></li>

<li><p>Self Join; one table, e.g., all the weather records that are in the temperature range of other weather records.</p></li>

<li><p>Aggregate Functions</p>

<pre><code class="language-sql">SELECT max(temp_lo) FROM weather;  
-- max: 46
</code></pre>

<pre><code class="language-sql">SELECT city FROM weather
    WHERE temp_lo = (SELECT max(temp_lo) FROM weather); 
-- city: San Francisco
</code></pre></li>

<li><p><a href="https://www.postgresql.org/docs/current/tutorial-window.html">Window Functions</a> &mdash; Perform a calculation across (<code>OVER</code>) a set of table rows that are somehow related to the current row.</p>

<pre><code class="language-sql">SELECT uname, 
    ROW_NUMBER () OVER (PARTITION BY idx ORDER BY idx),
    pass_hash
    WHERE pass_hash = 'bogus'
FROM users;
</code></pre>

<ul>
<li><p>Resets the idx (<a href="https://www.postgresqltutorial.com/postgresql-row_number/">row count</a>) to that of filtered result(s).</p>

<pre><code class="language-sql">SELECT depname, empno, salary, avg(salary) 
OVER (PARTITION BY depname) FROM empsalary;

-- order, then add a rank per value
SELECT depname, empno, salary,
rank() OVER (PARTITION BY depname ORDER BY salary DESC)
FROM empsalary;
</code></pre></li>
</ul></li>

<li><p><a href="https://attacomsian.com/blog/export-postgresql-table-data-json/">Table to JSON</a></p>

<pre><code class="language-sql">SELECT array_to_json(array_agg(row_to_json (r))) 
FROM (
    SELECT first_name, last_name, email, first_name || ' ' || last_name as name 
    FROM users;
) r;
</code></pre></li>
</ul>

<h3>Updates <a href="https://www.postgresql.org/docs/current/sql-update.html">(<code>UPDATE</code>)</a></h3>

<pre><code class="language-sql">UPDATE weather
    SET temp_hi = temp_hi - 2,  temp_lo = temp_lo - 2
    WHERE date &gt; '1994-11-28';
</code></pre>

<p><code>WHERE col_name IN ('val1', 'val2', ...)</code></p>

<pre><code class="language-sql">UPDATE users SET 
    pass_hash = pw_hash('abc123'),
    date_update = now()
    WHERE handle IN ('foo', 'bar', 'boofar');
</code></pre>

<ul>
<li><p><a href="https://www.postgresql.org/docs/11/tutorial-transactions.html">Transactions</a>  &mdash; Bundle <strong>multiple steps</strong> into a single, <strong>all-or-nothing</strong> operation</p>

<pre><code class="language-sql">-- per transaction
BEGIN;
UPDATE accounts SET balance = balance - 100.00
    WHERE name = 'Alice';
SAVEPOINT my_savepoint;
UPDATE accounts SET balance = balance + 100.00
    WHERE name = 'Bob';
-- oops ... forget that and use Wally's account
ROLLBACK TO my_savepoint;
UPDATE accounts SET balance = balance + 100.00
    WHERE name = 'Wally';
COMMIT;
</code></pre></li>

<li><p><code>RETURNING</code>; use to validate; to return only those rows affected.</p>

<pre><code class="language-sql">UPDATE messages 
SET body = 'Newer content' 
WHERE msg_id = 3 
RETURNING msg_id;
</code></pre></li>
</ul>

<h3>Deletions <a href="https://www.postgresql.org/docs/current/sql-delete.html">(<code>DELETE</code>)</a></h3>

<pre><code class="language-sql">DELETE FROM weather WHERE city = 'Hayward';
</code></pre>

<ul>
<li><p><code>ON DELETE RESTRICT</code><br>
If <code>product_no</code> entry exists at <code>order_items</code> (junction) table, then prohibit its removal at <code>products</code> table.</p></li>

<li><p><code>ON DELETE CASCADE</code><br>
If <code>order_id</code> entry is removed at <code>orders</code> table, then remove its entry at  <code>order_items</code> (junction) table too.</p></li>

<li><p>Other actions:</p>

<ul>
<li><p><code>ON UPDATE</code>; where <code>CASCADE</code> means copy to the referencing row(s).</p></li>

<li><p><code>NO ACTION</code>; if any referencing rows still exist when the constraint is checked, an error is raised; this is the default behavior.</p></li>

<li><p><code>SET NULL</code>, <code>SET DEFAULT</code>; the referencing column(s) in the referencing row(s) set to null or default values, respectively, when the referenced row is deleted.</p></li>
</ul></li>
</ul>

<blockquote>
<p>Greatly simplies CRUD logic of external code.</p>
</blockquote>

<h4>Conditional <code>DELETE</code></h4>

<p>Delete record(s) of a table <strong><em>per result of a query upon another table</em></strong>. The following example deletes all old short-form messages of no interest to any other member <code>AND</code> authored by any member having no buyin. That last &quot;<code>AND</code>&quot; is conditional upon read result, <code>EXISTS(SELECT...)</code>, from logic upon another table (<code>users</code>).</p>

<pre><code class="language-sql">DELETE FROM messages 
WHERE CURRENT_TIMESTAMP - date_update &gt; 10 * interval '1 hour'
AND count_replies = 0
AND repubs = 0
AND sponsub = 0
AND tokens_q &lt;= 0
AND tokens_p = 0
AND size &lt; 1024
AND EXISTS (
    SELECT idx FROM users 
    WHERE users.user_id = messages.author_id
    AND users.acc_buyin = 0
);
</code></pre>

<h3>Junction Table to Resolve Many-to-Many Relationships</h3>

<pre><code>M:M  ==&gt;  M:1&gt;--&lt;1:M
</code></pre>

<pre><code class="language-sql">-- M:M @ products:orders
CREATE TABLE products (
    product_no integer PRIMARY KEY,
    name text,
    price numeric
);

CREATE TABLE orders (
    order_id integer PRIMARY KEY,
    shipping_address text,
    ...
);

-- resolve (w/ constraints) @ junction table
CREATE TABLE order_items (
    product_no integer RENCES products ON DELETE RESTRICT,
    order_id integer RENCES orders ON DELETE CASCADE,
    quantity integer,
    PRIMARY KEY (product_no, order_id)
);
</code></pre>

<h2><a href="https://www.postgresql.org/docs/9.6/app-psql.html#APP-PSQL-VARIABLES">Variables</a> | <a href="https://www.postgresql.org/docs/9.6/app-psql.html"><code>psq</code>l meta-commands</a></h2>

<h3><code>\set key1 val1</code></h3>

<p>Use @ <code>:key1</code>, <code>:'key1'</code>, or <code>(:key1)</code></p>

<pre><code class="language-sql">-- :key1
\set idx 5
DELETE FROM users where user_id = :idx;

-- :'key1'
\set cid 'f4a21a19-5fb8-4e5d-ac89-b54f4bd5c81f'
SELECT get_msglist_chan_json(:'cid', now(), 99);

-- (:key1)
\set cid 'select distinct chan_id from messages where body = \'__FAUX__\''
select get_msglist_chan_json((:cid), now(), 99)
</code></pre>

<ul>
<li>Note to enter <code>psql</code> meta-command <strong><em>sans semicolon</em></strong>, unlike SQL commands.</li>
</ul>

<h2><a href="https://www.postgresql.org/docs/current/queries-with.html">CTE (Common Table Expressions) AKA <code>WITH</code> Queries</a></h2>

<p><code>WITH fooVar AS (query)</code> provides a way to write auxiliary statements for use in a larger query, <strong><em>for improved performance</em></strong>; define <em>temporary tables</em> that exist just <em>for one query</em>, and <em>set its result to a variable</em>. CTEs may be utilized to perform some subset of what otherwise requires a PostgreSQL <a href="#trigger"><code>trigger</code> function</a>.</p>

<pre><code class="language-sql">-- Two CTEs; the second utilizing the first. 
WITH regional_sales AS ( -- CTE; sets its query result to `regional_sales` var
        SELECT region, SUM(amount) AS total_sales
        FROM orders
        GROUP BY region
     ), 
     top_regions AS ( -- CTE; sets its query result to `top_sales` var 
        SELECT region
        FROM regional_sales
        WHERE total_sales &gt; (SELECT SUM(total_sales)/10 FROM regional_sales)
     )
-- Main query; access var `regional_sales` 
SELECT region,
       product,
       SUM(quantity) AS product_units,
       SUM(amount) AS product_sales
FROM orders
WHERE region IN (SELECT region FROM top_regions) 
GROUP BY region, product;
</code></pre>

<h4><code>WITH RECURSE</code></h4>

<p><em>The general form of a recursive <code>WITH</code> query is always a non-recursive term, then <code>UNION</code> (or <code>UNION ALL</code>), then a recursive term, where only the recursive term can contain a reference to the query's own output.</em></p>

<pre><code class="language-sql">SELECT DISTINCT mm.* FROM ( 
    SELECT m1.* FROM vw_messages m1 
    WHERE tokens_q &gt; 0

    UNION ALL

    SELECT m2.* FROM vw_messages m2 
    WHERE tokens_p &gt; 0
) mm
ORDER BY mm.tokens_p, mm.tokens_q DESC
LIMIT 20;
</code></pre>

<pre><code class="language-sql">SELECT DISTINCT mm.* FROM ( 
    WITH RECURSIVE xx AS(

        SELECT tx.* 
        FROM vw_messages tx 
        JOIN vw_messages rx
        ON tx.to_id = rx.msg_id        
        AND rx.author_id = uid   

        UNION ALL

        SELECT mx.*
        FROM vw_messages mx
        JOIN xx ON mx.to_id = xx.msg_id 

    ) SELECT * FROM xx
    ...
) mm
</code></pre>

<h2><a href="https://www.postgresql.org/docs/11/rules-views.html" title="postgresql.org">Views</a></h2>

<ul>
<li><p>A stored query; like a function but takes no param. Create a view over a query; to <strong>maintain constistant interfaces</strong> even as an application's <strong><em>tables evolve</em></strong>;  encapsulates structural details. (<a href="https://www.postgresql.org/docs/current/tutorial-views.html" title="postgresql.org">Tutorial</a>); <strong>views are not rules</strong> per se, but <em>use the query rewrite rules</em>; a key aspect of good SQL database design;</p>

<pre><code class="language-sql">-- create  
CREATE VIEW myview AS
SELECT city, temp_lo, temp_hi, prcp, date, location
    FROM weather, cities
    WHERE city = name;
-- use 
SELECT * FROM myview;
</code></pre></li>
</ul>

<h2><a href="https://www.postgresql.org/docs/11/rules-materializedviews.html" title="postgresql.org"><strong>Materialized Views</strong></a></h2>

<ul>
<li><p>Persist view (a query) results in a table-like form; <strong><em>cache</em></strong>. Faster than a table query, but may be stale.</p>

<pre><code class="language-sql">-- derived from views table
DROP MATERIALIZED VIEW IF EXISTS mv_views_cfg CASCADE;
CREATE MATERIALIZED VIEW IF NOT EXISTS mv_views_cfg AS (
SELECT DISTINCT
    view_id,
    vname
FROM views  
WHERE etag = 'mv-cfg'
);

-- Update source table
INSERT INTO views (vname, etag, view_id) 
SELECT 'ghost-view', 'mv-cfg', uuid_nil() -- required @ mv_channels_cfg MV
WHERE NOT EXISTS (SELECT 1 FROM views WHERE vname = 'ghost-view');

-- Refresh the MV, else remains unchanged (stale).
ESH MATERIALIZED VIEW mv_views_cfg;
</code></pre></li>
</ul>

<h2><code>CREATE</code> <a href="https://www.postgresql.org/docs/12/sql-createtable.html"><code>UNLOGGED TABLE ...</code></a></h2>

<blockquote>
<p>&quot;Data written to unlogged tables is not written to the write-ahead log, which makes them <strong><em>considerably faster</em></strong> than ordinary tables. However, ... not crash-safe ... not replicated to standby servers ...&quot;</p>
</blockquote>

<h2><a href="https://www.postgresql.org/docs/11/server-programming.html" title="postgresql.org">Server Programming</a></h2>

<ul>
<li><p><a href="https://www.postgresql.org/docs/11/extend-type-system.html" title="postgresql.org">PostgreSQL Type System</a></p></li>

<li><p>Rules; <a href="https://wiki.postgresql.org/wiki/Don't_Do_This#Don.27t_use_rules">don't use them</a>. Use <strong>triggers</strong> instead. (See <code>CREATE FUNCTION</code> below.)</p>

<ul>
<li><p>The Query Rewrite <a href="https://www.postgresql.org/docs/11/rules.html" title="postgresql.org">Rule System</a></p>

<blockquote>
<p>&hellip;  <strong>modifies queries</strong> to take rules into consideration, and then passes the modified query to the query planner for planning and execution. &hellip; very powerful &hellip; used for many things such as query language <strong>procedures</strong>, <strong>views</strong>, and <strong>versions</strong>.</p>
</blockquote></li>
</ul></li>
</ul>

<h3><a href="https://www.postgresqltutorial.com/postgresql-stored-procedures/">Stored Procedures</a></h3>

<p>Confusing lingo; three types of such &hellip;</p>

<ul>
<li><code>FUNCTION</code> &mdash; takes args; has returns or not

<ul>
<li><code>TRIGGER</code> &mdash; does not take args</li>
</ul></li>
<li><code>PROCEDURE</code> &mdash; has no return</li>
</ul>

<h3><a href="https://www.postgresql.org/docs/current/functions.html" title="postgresql.org">Functions and Operators</a>  | <a href="https://www.postgresql.org/docs/11/xfunc-sql.html" title="postgresql.org">SQL Functions</a> | <a href="https://www.postgresql.org/docs/13/plpgsql-control-structures.html" title="RETURN ..., RETURNING ..., IF-THEN-ELSEIF, CASE-WHEN-ELSE-END">Control Structures</a></h3>

<p>Allow us to group <strong>a block of <code>SQL</code> statements</strong> <em>inside the database server</em>; radically reduce client/server comms overhead.</p>

<p>Using <a href="https://www.postgresql.org/docs/11/xplang.html" title="postgresql.org">Procedural Languages</a>;  <code>PL/pgSQL</code>, <code>PL/Tcl</code>, <code>PL/Python</code>, ...; loadable.</p>

<ul>
<li>These are more flexible than SQL functions; the power of a procedural language and the ease of SQL. <a href="https://www.postgresql.org/docs/11/plpgsql-structure.html" title="postgresql.org">Structure of <code>PL/pgSQL</code></a>:</li>
</ul>

<h4><code>SQL</code> vs. <code>PL/pgSQL</code></h4>

<pre><code class="language-sql">-- @ SQL (standard)
CREATE OR REPLACE FUNCTION set_chan(oid INT, vid INT, frag TEXT)
    RETURNS TABLE (chan_id INT) AS
$BODY$
    INSERT INTO channels (owner_id, view_id, slug) 
        VALUES (oid, vid, frag) 
        RETURNING channels.chan_id;
$BODY$ LANGUAGE SQL;


-- @ PL/pgSQL
CREATE OR REPLACE FUNCTION set_chan(oid INT, vid INT, frag TEXT)
    RETURNS TABLE (chan_id INT) AS
$BODY$
BEGIN
    RETURN QUERY -- Else err: &quot;query has no destination for result data&quot;
    INSERT INTO channels (owner_id, view_id, slug) 
        VALUES (oid, vid, frag) 
        RETURNING channels.chan_id;
END
$BODY$ LANGUAGE 'plpgsql';
</code></pre>

<h3><a href="https://www.postgresql.org/docs/13/plpgsql-control-structures.html" title="RETURN ..., RETURNING ..., IF-THEN-ELSEIF, CASE-WHEN-ELSE-END">Control Structures</a></h3>

<p><code>RETURN</code> ..., <code>RETURNING</code> ..., <code>IF-THEN-ELSEIF</code>, <code>CASE-WHEN-ELSE-END</code></p>

<h4>Return Base Types</h4>

<pre><code class="language-sql">CREATE FUNCTION somefunc(integer, text) 
RETURNS integer AS 
$BODY$
BEGIN
-- ... the function body 
END
$BODY$
LANGUAGE plpgsql;
</code></pre>

<p><a href="https://www.postgresql.org/docs/current/sql-syntax-lexical.html#SQL-SYNTAX-DOLLAR-QUOTING" title="postgresql.org">Dollar Quoting</a></p>

<h5>Load a function per SQL file :: <code>\i funcDef.sql</code></h5>

<h4><a href="https://www.postgresql.org/docs/11/xfunc-sql.html#XFUNC-SQL-COMPOSITE-FUNCTIONS">Return Composite types</a> @ <strong>1 row</strong></h4>

<pre><code class="language-sql">INSERT INTO emp VALUES ('Bill', 4200, 45, '(2,1)');

CREATE FUNCTION double_salary(emp) 
RETURNS numeric AS 
$$
    SELECT $1.salary * 2 AS salary;
$$ LANGUAGE SQL;

SELECT name, double_salary(emp.*) AS dream
    FROM emp
    WHERE emp.cubicle ~= point '(2,1)';
</code></pre>

<h4><a href="https://www.postgresql.org/docs/11/xfunc-sql.html#XFUNC-SQL-FUNCTIONS-RETURNING-TABLE">Return <code>TABLE</code></a> @ <strong>one or more rows</strong></h4>

<ul>
<li><p><strong><em>Returns 1 row regardless</em></strong>; <code>NULL</code>s <em>if 0 rows match!</em></p>

<pre><code class="language-sql">CREATE FUNCTION get_table(id int) 
RETURNS tblname AS 
$$
SELECT * FROM tblname WHERE idx = id;
$$ LANGUAGE SQL;

CREATE FUNCTION sum_n_product_with_tab (x int)
RETURNS TABLE(sum int, product int) AS 
$$
SELECT $1 + t1.y, $1 * t1.y FROM t1;
$$ LANGUAGE SQL;
</code></pre></li>

<li><p>Note: Must omit or include <code>TABLE</code>, per pointsfree versus not pointsfree styles:</p>

<ul>
<li><code>RETURNS tblname</code></li>
<li><code>RETURNS TABLE(...) AS</code></li>
</ul></li>
</ul>

<p>Per <code>RETURN QUERY</code> @ <code>plpgSQL</code></p>

<pre><code class="language-sql">CREATE OR REPLACE FUNCTION get_film (p_pattern VARCHAR) 
	RETURNS TABLE (
		film_title VARCHAR,
		film_release_year INT
) 
AS $$
BEGIN
	RETURN QUERY SELECT
		title,
		cast( release_year as integer)
	FROM
		film
	WHERE
		title ILIKE p_pattern ;
END; $$ 
LANGUAGE 'plpgsql';
</code></pre>

<p>Use a function as a <code>TABLE</code> source; per referenced-table name (<code>foo</code>)</p>

<pre><code class="language-sql">CREATE FUNCTION getfoo(int) RETURNS foo AS $$
    SELECT * FROM foo WHERE fooid = $1;
$$ LANGUAGE SQL;

SELECT *, upper(fooname) FROM getfoo(1) AS t1;
</code></pre>

<h4><a href="https://www.postgresql.org/docs/11/xfunc-sql.html#XFUNC-SQL-FUNCTIONS-RETURNING-SET">Return <code>SETOF</code> (UNTYPED)</a> @ <strong>one or more rows</strong> of a <code>TABLE</code></h4>

<ul>
<li><strong><em>Returns 0 rows if no match</em></strong>, unlike <code>RETURNS foo</code>, which <strong><em>returns 1 row regardless</em></strong>.</li>

<li><p>Returns <strong><em>untyped</em></strong> columns, so is <em>not</em> SQL compatible.</p>

<pre><code class="language-sql">CREATE FUNCTION getfoo(int) 
RETURNS SETOF foo AS 
$$
SELECT * FROM foo WHERE fooid = $1;
$$ LANGUAGE SQL;

SELECT * FROM getfoo(1) AS t1;
</code></pre></li>
</ul>

<h5>How to retrieve the table rows per <strong><em>pointfree</em></strong> style</h5>

<p><code>SETOF table_name</code></p>

<pre><code class="language-sql">DROP FUNCTION IF EXISTS get_owner(UUID);
CREATE OR REPLACE FUNCTION get_owner(cid UUID)
    --RETURNS TABLE (user_id UUID, uname TEXT, email TEXT) AS
    RETURNS SETOF users AS
    --RETURNS SETOF users AS -- ERROR type mismatch ???
$BODY$
    SELECT u.* FROM users u
    INNER JOIN channels c
    ON u.user_id = c.owner_id
    WHERE c.chan_id = cid 
$BODY$
LANGUAGE SQL;

-- SUCCESS (return is typed)
SELECT * FROM get_owner('84944737-e5e4-4ebf-855a-cc3306781603');
-- SUCCESS (return is untyped)
SELECT get_owner('84944737-e5e4-4ebf-855a-cc3306781603');
</code></pre>

<p>However, we can <a href="https://stackoverflow.com/questions/22423958/sql-function-return-type-table-vs-setof-records" title="2016 @ StackOverflow.com">declare a type, and reference it</a> thereafter.</p>

<pre><code class="language-sql">CREATE TYPE footype AS (score int, term text);

CREATE FUNCTION foo() RETURNS SETOF footype AS $$
   SELECT * FROM ( VALUES (1,'hello!'), (2,'Bye') ) t;
$$ language SQL immutable;

CREATE FUNCTION foo_tab() RETURNS TABLE (score int, term text) AS $$
   SELECT * FROM ( VALUES (1,'hello!'), (2,'Bye') ) t;
$$ language SQL immutable;

SELECT * FROM foo();      -- works fine!
SELECT * FROM foo_tab(); 
</code></pre>

<h4><a href="https://www.postgresql.org/docs/11/xfunc-sql.html#XFUNC-SQL-FUNCTIONS-RETURNING-SET">Return <code>SETOF</code> RECORD (UNTYPED)</a> @ <strong>one or more rows</strong> of a <code>TABLE</code></h4>

<pre><code class="language-sql">CREATE OR REPLACE FUNCTION storeopeninghours_tostring(numeric)
 RETURNS SETOF RECORD AS $$
DECLARE
 open_id ALIAS FOR $1;
 result RECORD;
BEGIN
 RETURN QUERY SELECT '1', '2', '3';
 RETURN QUERY SELECT '3', '4', '5';
 RETURN QUERY SELECT '3', '4', '5';
END
$$;
</code></pre>

<ul>
<li><p>Since untyped, &amp;hellip</p>

<pre><code class="language-sql">-- FAIL
SELECT * FROM storeopeninghours_tostring(2);
-- SUCCESS
SELECT storeopeninghours_tostring(2);
</code></pre>

<pre><code class="language-sql">CREATE OR REPLACE FUNCTION public.exec(text)
RETURNS SETOF RECORD
AS $BODY$
BEGIN 
RETURN QUERY EXECUTE $1; 
END 
$BODY$ 
LANGUAGE 'plpgsql';

-- Usage:
SELECT * FROM exec('SELECT now()') AS t(dt timestamptz);
</code></pre></li>
</ul>

<h4>Return per <code>OUT</code> params; <code>OUT var TYPE</code></h4>

<p>Useful when return is a basic type (vs a  composite, <code>TABLE</code>, etal)</p>

<pre><code class="language-sql">CREATE FUNCTION add_em (IN x int, IN y int, OUT sum int)
AS 'SELECT x + y'
LANGUAGE SQL;

SELECT add_em(3,7);
</code></pre>

<ul>
<li>Note no need for <code>FROM</code> clause.</li>
</ul>

<h4>Return <code>void</code></h4>

<pre><code class="language-sql">CREATE FUNCTION clean_emp() RETURNS void AS '
    DELETE FROM emp
        WHERE salary &lt; 0;
' LANGUAGE SQL;

SELECT clean_emp();
</code></pre>

<h3><code>LATERAL</code> : <a href="https://www.postgresql.org/docs/current/sql-select.html"><code>SELECT f.col_3, x.* FROM foo f, LATERAL aFunc(f.bar) x ...</code></a></h3>

<blockquote>
<p>Call a function on column(s) of <em>each record</em> in a query,
returning its results (all or selected columns)
instead of, or in addition to, column(s) of the queried table.</p>
</blockquote>

<pre><code class="language-sql">-- Insert a user-scoped api key (VIP key) for each user having ...
SELECT x.handle, x.xid, x.api_key
FROM vw_users u,
    LATERAL insert_user_scoped_api_key(u.handle) x
WHERE u.roles @&gt; ARRAY['HOST']
AND (u.email LIKE '%@emx.unk');
</code></pre>

<pre><code class="language-text">  handle                       xid                                  api_key
SlowMoFTW      b03048a8-24c3-4658-b645-c7c6eecefa8b    AWTTFKRTQX4XCZLR3D6JGWLPBL.bnP...oNv
TheRetorter    bd8479d6-111c-42e3-a49d-25423535cb39    HZ4CI21144KBMRD6EEEGMJZ5TJ.JVC...Hsw
...
</code></pre>

<h3><a href="https://www.postgresqltutorial.com/plpgsql-cursor/"><code>CURSOR</code> @ PL/pgSQL</a> usage in a function | @ <a href="https://www.postgresql.org/docs/11/plpgsql-cursors.html"><code>/docs</code></a></h3>

<p>Rather than executing a whole query at once, it is possible to set up a cursor that encapsulates the query, and then read the query result a few rows at a time.</p>

<h3><a href="https://www.postgresql.org/docs/11/plpgsql-trigger.html" title="postgresql.org">Trigger Functions</a> <a name=trigger></a></h3>

<p>A function that binds to a table/event, and <strong><em>automatically triggers</em></strong> on <a href="https://www.postgresql.org/docs/11/plpgsql-trigger.html#PLPGSQL-DML-TRIGGER" title="postgresql.org">data changes</a> or <a href="https://www.postgresql.org/docs/11/plpgsql-trigger.html#PLPGSQL-EVENT-TRIGGER" title="postgresql.org">database events</a>. Unlike other functions, it <strong><em>does not accept any parameters</em></strong>.</p>

<pre><code class="language-sql">-- per CTE Postgres 9.1:
WITH rows AS (
    INSERT INTO Table1 (name) VALUES ('a_title') 
    RETURNING id
)
INSERT INTO Table2 (val)
SELECT id
FROM rows

-- per Trigger:
CREATE FUNCTION t1_ins_into_t2()
    RETURNS trigger AS 
$$
BEGIN
    INSERT INTO table2 (val) 
        VALUES (NEW.id);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER t1_ins_into_t2
    AFTER insert on table1
FOR EACH ROW
EXECUTE PROCEDURE t1_ins_into_t2();
</code></pre>

<h3><a href="https://www.postgresql.org/docs/11/xproc.html"><code>CREATE PROCEDURE</code></a></h3>

<p>A kind of function sans return; <em>unlike functions</em>, procedures <strong><em>allow transactions</em></strong></p>

<pre><code class="language-sql">CREATE OR REPLACE PROCEDURE set_transaction_q(payer INT, payee INT, msg INT, q INT)
LANGUAGE 'plpgsql'    
AS $$ -- ... returns void on success; ERROR on fail
BEGIN
    -- payer (from)
    UPDATE users SET tokens_q = tokens_q - q
        WHERE user_id = payer;
    -- payee (to)
    UPDATE users SET tokens_q = tokens_q + q
        WHERE user_id = payee;
    -- record 
    INSERT INTO transactions (payer_id, payee_id, msg_id, tokens_q) 
        VALUES (payer, payee, msg, q);
    COMMIT;
END;
$$;

CALL set_transaction_q(:payer, :payee, :msg, :q);
</code></pre>

<h4>Transaction @ <code>PROCEDURE</code> <a href="https://www.postgresql.org/docs/11/plpgsql-transactions.html"><code>BEGIN ... COMMIT ... ROLLBACK</code></a></h4>

<pre><code class="language-sql">CREATE PROCEDURE transaction_test1()
LANGUAGE plpgsql
AS $$
BEGIN
    FOR i IN 0..9 LOOP
        INSERT INTO test1 (a) VALUES (i);
        IF i % 2 = 0 THEN
            COMMIT;
        ELSE
            ROLLBACK;
        END IF;
    END LOOP;
END
$$;

CALL transaction_test1();
</code></pre>

<h2><code>LOCK</code></h2>

<p>This is a per table, per transaction <strong>write</strong> lock; all other users are prevented from writing to the table whilst under lock.</p>

<pre><code class="language-sql">BEGIN;
LOCK TABLE foo IN ACCESS EXCLUSIVE MODE;
-- All other users are now restricted to read-only mode at this table.
-- ... Do stuff to foo table and/or its constraints, then ...
COMMIT; -- Unlock the table.
</code></pre>

<h2><a href="http://www.tutorialspoint.com/postgresql/" title="tutorialspoint.com">PostgreSQL Tutorial</a></h2>

<h2><a href="https://www.postgresql.org/docs/current/reference-client.html">All Native PostgreSQL Client Apps</a></h2>

<h2><a href="https://www.postgresql.org/docs/current/pgbench.html"><code>pgbench</code> :: benchmark tests</a></h2>

<pre><code class="language-bash">su - postgres  # switch to 'postgres' user (@ alpine)
</code></pre>

<pre><code class="language-bash">psql -c 'SHOW config_file'
psql -c 'SELECT version();'     # version of SERVER (postgres daemon)
psql --version                  # version of CLIENT (psql) 
# Initialize
pgbench -i -p 5432 -d postgres
#...
# Test w/ 10 clients 
pgbench -c 10  # -T &lt;SECONDS&gt;
#...
starting vacuum...end.
transaction type: &lt;builtin: TPC-B (sort of)&gt;
scaling factor: 1
query mode: simple
number of clients: 10
number of threads: 1
number of transactions per client: 10
number of transactions actually processed: 100/100
latency average = 23.646 ms
tps = 422.909536 (including connections establishing)
tps = 426.859358 (excluding connections establishing)
#... tps = Transactions Per Second 

# -S (SELECT only; read only), -n (skip vacuum)
pgbench -c 100 -T 300 -S -n
# Try tweaking params: `shared_buffers` and `effective_cache_size` 
# @ postgresql.conf
exit # back to root user
apt-get update
apt-get install vim 
su - postgres
vim /var/lib/postgresql/data/postgresql.conf 
</code></pre>

<p>@ <code>bench.sql</code> (<a href="bench.init.sql"><code>bench.init.sql</code></a>)</p>

<pre><code class="language-sql">INSERT INTO test_bench VALUES(1,'test');
INSERT INTO test_bench VALUES(1,'test');
SELECT * FROM test_bench WHERE id=1;
SELECT * FROM test_bench WHERE id=2;
</code></pre>

<ul>
<li><p>A workload of 50% reads and 50% writes (or a 60:40 environment).</p>

<pre><code class="language-bash">pgbench -c 100 -T 3 -S -n -f bench.sql 

postgres@30420c4a8027:/home/2020-lab-1$ pgbench -c 100 -T 3 -S -n -f bench.sql
transaction type: multiple scripts
scaling factor: 1
query mode: simple
number of clients: 100
number of threads: 1
duration: 3 s
number of transactions actually processed: 5538
latency average = 57.473 ms
tps = 1739.939481 (including connections establishing)
tps = 1741.067620 (excluding connections establishing)
SQL script 1: &lt;builtin: select only&gt;
- weight: 1 (targets 50.0% of total)
- 2738 transactions (49.4% of total, tps = 860.230101)
- latency average = 7.073 ms
- latency stddev = 9.057 ms
SQL script 2: bench.sql
- weight: 1 (targets 50.0% of total)
- 2800 transactions (50.6% of total, tps = 879.709380)
- latency average = 94.788 ms
- latency stddev = 41.833 ms
</code></pre></li>
</ul>

<h2><a href="https://www.postgresql.org/docs/10/app-psql.html"><code>psql</code> :: client CLI utility</a></h2>

<ul>
<li><p>Start a session @ server, and issue commands therein ...</p>

<pre><code class="language-bash">$ psql -h 'localhost' -p '5432' -U 'postgres' -d 'foo'
psql (11.2 (Ubuntu 11.2-1.pgdg18.04+1))
...
foo=# select domain,path,html from public.comments;
</code></pre></li>

<li><p>Or, per command, from the host ...</p>

<pre><code class="language-bash">$ psql -h 'localhost' -p '5432' -U 'postgres' -d 'foo' \
    -c 'select domain,path,html from public.comments;'
</code></pre></li>
</ul>

<h3>SQL @ host per <code>psql</code></h3>

<pre><code class="language-bash"># SQL ...
psql -c '\x' -c 'SELECT * FROM foo;'
# or
echo '\x \\ SELECT * FROM foo;' | psql
</code></pre>

<h3>SQL @ server session per <code>psql</code></h3>

<pre><code class="language-bash"># Connect, then enter SQL statements directly 
$ psql -h &lt;host&gt; -p &lt;port&gt; -U &lt;user&gt; -W &lt;pass&gt; &lt;database&gt;

SELECT * FROM foo;

SELECT version();    # show PostgreSQL SERVER version  
SELECT current_date;
SELECT 2 + 2;
</code></pre>

<h3><code>psql</code> :: commands</h3>

<pre><code class="language-bash">su - postgres  # switch to 'postgres' user (@ alpine)
</code></pre>

<pre><code class="language-bash">psql -c 'SHOW config_file'
psql -c 'SELECT version();'     # version of SERVER (postgres daemon) 
psql --version                  # version of CLIENT (psql) 
# Connect to database at remote host
$ psql -h &lt;host&gt; -p &lt;port&gt; -U &lt;user&gt; -W &lt;pass&gt; &lt;database&gt;
# Connect locally
$ psql -U &lt;user&gt; 
psql (11.2 (Debian 11.2-1.pgdg90+1))
Type &quot;help&quot; for help.
&lt;user&gt;=&gt;   # cmd prompt @ psql session, if restricted user
&lt;user&gt;=#   # cmd prompt @ psql session, if superuser (@ docker|installer)

# psql commands ...
    \h               # help   
    \l               # List databases  
    \c $DB_NAME      # Connect to database  
    \d               # Display tables list 
    \d+ $TABLE_NAME  # Display table schema (collumn names and data type)  
    \x               # Expanded display (toggle); much more verbose
    \q               # Quit; end session; terminate the forked server process 
</code></pre>

<ul>
<li>Those <code>psql</code> commands cause failures when run as scripts in Adminer and such wrappers.</li>
</ul>

<h4>@ Docker container (<a href="postgres.docker.sh"><code>postgres.docker.sh</code></a>)</h4>

<pre><code class="language-bash"># @ Container shell (bash) ...

root@f3e668efe2a2:/home# pushd home 
root@f3e668efe2a2:/home# psql -U postgres -f ./sql/wipe.sql
root@f3e668efe2a2:/home# psql -U postgres -f ./sql/migrate.sql
root@f3e668efe2a2:/home# psql -U postgres -f ./sql/seeds.sql

root@f3e668efe2a2:/home# psql -U postgres -c 'SELECT * from topics'
root@50a7156ab294:/home# psql -U postgres -c 'SELECT owner_id as id, slug as path FROM channels'

# @ Launch INTERACTIVE client session (PostgreSQL)

root@f3e668efe2a2:/home# psql -U postgres
</code></pre>

<p>@ interactive session &hellip;</p>

<pre><code class="language-client">postgres=# \l
postgres=# \d
postgres=# \d+ channels 

postgres=# SELECT owner_id AS id, slug AS path FROM channels;
                  id                  |  path
--------------------------------------+--------
 45b5fbd3-755f-4379-8f07-a58d4a30fa2f | slug-1
 5cf37266-3473-4006-984f-9325122678b7 | slug-2
 45b5fbd3-755f-4379-8f07-a58d4a30fa2f | slug-3
</code></pre>

<h3><a href="https://www.postgresql.org/docs/current/runtime-config.html">Server Config</a></h3>

<ul>
<li><code>/etc/postgresql/postgresql.conf</code></li>
<li><code>/var/lib/postgresql/data/postgresql.conf</code></li>
</ul>

<h4>Show Location:</h4>

<pre><code class="language-sql">SHOW config_file;
</code></pre>

<ul>
<li>Sample config included @ <a href="https://hub.docker.com/_/postgres" title="hub.docker.com">PostgreSQL images</a>:

<ul>
<li><code>/usr/share/postgresql/postgresql.conf.sample</code></li>
<li><code>/usr/local/share/postgresql/postgresql.conf.sample</code> @ Alpine variants</li>
</ul></li>
</ul>

<h4>Reload @ running server:</h4>

<ul>
<li><p>@ <code>bash</code> :: <code>pg_ctl</code></p>

<pre><code class="language-bash">pg_ctl reload
</code></pre></li>

<li><p>@ SQ: :: <code>psql</code></p>

<pre><code class="language-sql">SELECT pg_reload_conf()
</code></pre>

<pre><code class="language-bash"># Query the server for its config file ...
$ psql -h $host -U $user -c 'SHOW config_file;'
           config_file
------------------------------------------
/var/lib/postgresql/data/postgresql.conf
(1 row)  # ... @ a running Docker container
</code></pre></li>
</ul>

<h3>Create a database</h3>

<ul>
<li><p>@ <code>psql</code> utility</p>

<pre><code class="language-bash">$ psql ...
# @ PostgreSQL server session ...
CREATE DATABASE dbname;
</code></pre></li>

<li><p>@ <code>createdb</code> utility</p>

<pre><code class="language-bash">$ createdb [-U USERNAME] ['dbname']  # default dbname is USERNAME
</code></pre></li>
</ul>

<h3>Destroy a database</h3>

<ul>
<li><p>@ <code>dropdb</code> utility</p>

<pre><code class="language-bash">$ dropdb 'dbname'
</code></pre></li>
</ul>

<h3><a href="https://www.postgresql.org/docs/current/backup.html">Backup/Restore a Database</a> | <a href="https://mattsegal.dev/postgres-backup-automate.html" title="mattsegal.dev @ 2020">Automate</a></h3>

<ul>
<li><a href="https://www.postgresql.org/docs/12/warm-standby.html#SYNCHRONOUS-REPLICATION">Synchronous Replication</a></li>

<li><p><a href="https://www.postgresql.org/docs/10/backup-dump.html">Backup a Database</a></p>

<ul>
<li><p><a href="https://www.postgresql.org/docs/current/app-pgdump.html">@ <code>pg_dump</code></a> utility. Generate a text file with SQL commands that, when fed back to the server, will <strong>recreate the database in the same state</strong> as it was at the time of the dump.</p>

<ul>
<li><code>-a</code> ; <code>--data-only</code></li>
<li><code>-s</code> ; <code>--schema-only</code></li>
<li><code>-t</code> ; <code>--table &lt;TABLE&gt;</code></li>

<li><p><code>-w</code> ; <code>--no-password</code> ; <a href="https://www.postgresql.org/docs/current/libpq-pgpass.html">Sans prompt</a>; use a <strong>password file</strong>: <code>chmod 600 ~/.pgpass</code>, or <strong>environment variable</strong>, <code>PGPASSFILE: host:port:db:user:pass</code></p>

<ul>
<li><p><code>~/.pgpass</code> is <strong><em>absolutely worthless</em></strong> in container-ized environments; owner/perms (<code>chown</code>/<code>chmod</code>) of FILE must match that of (CONTAINER's) db USER.</p>

<pre><code class="language-bash"># Entire database, as SQL
pg_dump -U $user -Fc 'dbname' &gt; 'dumpfile.sql'
pg_dump -U $user -Ft 'dbname' &gt; 'dumpfile.tar'
</code></pre></li>
</ul></li>

<li><p><code>-Fc</code>; <code>--format=custom</code>; <em>Output a custom-format archive suitable for input into <code>pg_restore</code></em>.</p>

<pre><code class="language-bash"># Table, schema only, as SQL
$ pg_dump -h $_host -p $_port -U $_user \
-d $_db -t $_table -s  &gt; $_db.$_table.sql
</code></pre></li>
</ul></li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/backup-dump.html#BACKUP-DUMP-RESTORE">Restore a Database</a></p>

<ul>
<li><p><a href="https://www.postgresql.org/docs/current/app-pgrestore.html">@ <code>pg_restore</code></a> utility; use if large/compressed dumpfile.</p>

<pre><code class="language-bash"># Script that deletes all objects and data in target db
psql -U $user -d $dbname -c '\i /home/wipe/wipe.sql' 
# Load new db objects and data, or whatever is contained in the source tar file
pg_restore -U $user -d $dbname 'dumpfile.tar'
</code></pre>

<ul>
<li><p>@ S3</p>

<pre><code class="language-bash"># Restore from the latest backup file
S3_TARGET=$S3_BUCKET/$LATEST_BACKUP_FILE
aws s3 cp $S3_TARGET - | pg_restore --dbname $DB_NAME --clean --no-owner
</code></pre></li>
</ul></li>

<li><p><a href="https://www.postgresql.org/docs/current/app-psql.html">@ <code>psql</code></a> utility</p>

<pre><code class="language-bash"># Restoring the dump
$ psql 'dbname' &lt; 'dumpfile'
</code></pre>

<pre><code class="language-bash">$ psql -h $host -p $port -U $user \
    --set ON_ERROR_STOP=on 'dbname' &lt; 'dumpfile'
</code></pre></li>
</ul></li>

<li><p>Clone :: Server-to-Server (Dump/Restore)</p>

<ul>
<li><p><a href="https://www.postgresql.org/docs/current/app-pgdump.html" title="postgresql.org">@ <code>pg_dump</code></a> piped to <code>psql</code></p>

<pre><code class="language-bash">$ pg_dump -h $host1 'dbname' | psql -h $host2 'dbname'
</code></pre></li>
</ul></li>
</ul>

<h2>@ Ubuntu/Debian</h2>

<ul>
<li>Installed PostgreSQL dir, e.g., @ <code>/opt/PostgreSQL/10.7</code></li>
<li>Better to use container/cloud-based service</li>
</ul>

<h2>Connect the backend server</h2>

<ul>
<li><p>Per <a href="https://docs.mattermost.com/install/sockets-db.html#with-unix-socket" title="@ Mattermost">UNIX Domain Sockets (<code>UDS</code>) or TCP/IP</a> Sockets.</p>

<ul>
<li><a href="https://lists.freebsd.org/pipermail/freebsd-performance/2005-February/001143.html" title="freebds.org 2005">The <code>UDS</code></a> are <a href="https://stackoverflow.com/questions/14973942/tcp-loopback-connection-vs-unix-domain-socket-performance" title="StackOverflow 2016">faster and more secure</a>.</li>

<li><p><a href="https://github.com/rigtorp/ipc-bench" title="2019 @ GitHub">Test @ <code>ipc-bench</code></a> :: <code>~ 7x</code> more throughput; <code>1/3</code> the latency.</p>

<pre><code>TCP  latency: 6 us
UDS  latency: 2 us
PIPE latency: 2 us

TCP  throughput: 0.253702 M msg/s
UDS  throughput: 1.733874 M msg/s
PIPE throughput: 1.682796 M msg/s
</code></pre></li>
</ul></li>
</ul>

<h3><a href="https://www.postgresql.org/docs/10/app-psql.html">Install <code>psql</code> @ Ubuntu</a></h3>

<pre><code class="language-bash">$ sudo apt install postgresql-client-common
$ sudo apt install postgresql-client-10
</code></pre>

<h3>Connect using <code>psql</code></h3>

<pre><code class="language-bash"># Connect as root using `psql` utility
$ sudo -U postgres psql
postgres=#
# as root, set user/creds 
ALTER USER postgres WITH PASSWORD 'foobar';
# Henceforth, login ...
$ psql -U postgres -h localhost
\q  # to exit 
</code></pre>

<h2><a href="https://hub.docker.com/_/postgres" title="hub.docker.com :: postgres">@ Docker</a></h2>

<h3>Run a Postgres server container</h3>

<pre><code class="language-bash">$ docker run -d -p 5432:5432 --name 'db' \
    -e POSTGRES_PASSWORD=$dbpw postgres
</code></pre>

<h3>Access the server</h3>

<pre><code class="language-bash">$ psql -h localhost -p 5432 -U ${POSTGRES_USER} 
Password for user postgres:
...
postgres=#
</code></pre>

<h3>Access the server container, per shell</h3>

<pre><code class="language-bash">$ docker exec -it $CNTNR_ID bash -c &quot;psql -U postgres&quot;
psql (11.2 (Debian 11.2-1.pgdg90+1))
Type &quot;help&quot; for help.

postgres=#
</code></pre>

<h3>... same, but in stages</h3>

<pre><code class="language-bash"># Access the running Postgres container per its ID
$ docker exec -it $CNTNR_ID bash 
root@b39a615060bc:/#
</code></pre>

<ul>
<li><p>Therein, connect using <a href="https://www.postgresql.org/docs/10/app-psql.html">Postgres client CLI utility (<code>psql</code>)</a></p>

<pre><code class="language-bash"># @ Username: &quot;postgres&quot;
$ psql -U postgres
psql (11.2 (Debian 11.2-1.pgdg90+1))
...
postgres=#
\q  # to exit
</code></pre>

<pre><code class="language-bash">\c postgres
\l
                                 List of databases
   Name    |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges
-----------+----------+----------+------------+------------+-----------------------
 postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
           |          |          |            |            | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
           |          |          |            |            | postgres=CTc/postgres

# ... this is the baseline state of a virgin PostgreSQL server
</code></pre>

<ul>
<li>If no database exists @ startup, then PostgreSQL creates this default database.</li>
</ul></li>
</ul>

<h2><a href="https://hub.docker.com/_/postgres" title="hub.docker.com :: postgres">PostgreSQL + adminer @ <code>docker stack</code> or <code>docker-compose</code></a></h2>

<pre><code class="language-bash">docker stack deploy -c 'postgres.stack.yml' 'postgres' 
# or 
docker-compose -f 'postgres.stack.yml' up
docker-compose -f 'postgres.stack.yml' down -v  # delete volume(s) too
</code></pre>

<ul>
<li><p><a href="postgres.pgadminer.yml">(<code>postgres.pgadminer.yml</code>)</a></p></li>

<li><p>GUI amin <a href="http://localhost:8080">@: <code>http://localhost:8080</code></a><br>
user: postgres<br>
pass: example<br>
db: postgres</p></li>

<li><p>CLI @ <code>psql</code>, inside the container:</p>

<pre><code class="language-bash">$ docker exec -it 'database_db_1' bash
root@e70e81c53d80:/# psql -U postgres
</code></pre></li>
</ul>

<h2><a href="https://hub.docker.com/r/dpage/pgadmin4" title="hub.docker.com :: dpage/pgadmin4">pgAdmin @ Docker</a></h2>

<pre><code class="language-bash">docker run -p 8080:80  \
    -e &quot;PGADMIN_DEFAULT_EMAIL=user@domain.com&quot; \
    -e &quot;PGADMIN_DEFAULT_PASSWORD=SuperSecret&quot; \
    --name 'pgadmin' \
    -d dpage/pgadmin4
</code></pre>

<h2>PostgreSQL + pgAdmin @ <code>docker stack</code> or <code>docker-compose</code></h2>

<ul>
<li><a href="postgres.pgadmin4.yml">(<code>postgres.pgadmin4.yml</code>)</a><br></li>

<li><p>GUI amin <a href="http://localhost:8080">@: <code>http://localhost:8080</code></a></p>

<pre><code>user: user@domain.com  
pass: SuperSecret  
</code></pre></li>

<li><p>CLI @ <code>psql</code>, inside the container:</p>

<pre><code class="language-bash">$ docker exec -it 'database_db_1' bash
root@e70e81c53d80:/# psql -U postgres
</code></pre></li>
</ul>

<h3>&nbsp;</h3>

<!-- 

# Bookmark

- Reference
[Foo](#foo)
- Target
<a name="foo"></a>

# [Markdown](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet "______")

([MD](___.html "@ browser"))   

-->
 
    </main>

    <script src="https://sempernow.github.io/refpages/sa/js/base.js"></script>
    <script>
        ;(function(o, undefined){
            'use strict'
            window.addEventListener('load', () => {
                ;(() => {})//()
                ;(() => {})//()
                ;(() => { // FOO LAB
                    const log = o.log('foo')
                        ,main = o.css('MAIN')
                    log('foo')
                    o.toDOM(main, '<h1>TEST</h1>')
                })//()
            })
        })( (typeof window !== 'undefined') 
            && (window[__APP__] = window[__APP__] || {})
                || (typeof global !== 'undefined') 
                    && (global[__APP__] = global[__APP__] || {})
        );
    </script>
</body>
</html>
