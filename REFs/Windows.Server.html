<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Windows.Server</title>
    <link rel="icon" href="https://sempernow.github.io/refpages/sa/favicon.png">
    <link rel="stylesheet" href="https://sempernow.github.io/refpages/sa/css/normalize.css">
    <link rel="stylesheet" href="https://sempernow.github.io/refpages/sa/css/main.css">
    <!--
    <link rel="stylesheet" href="https://sempernow.github.io/refpages/sa/css/dev.css">
    -->
    <link rel="stylesheet" href="https://sempernow.github.io/refpages/sa/css/hljs.github.min.css">
    <style>

    </style>
    <script src="https://sempernow.github.io/refpages/sa/js/hl.min.js"></script>
    <script>hljs.highlightAll()</script>
</head>
<body>
    <main>
        <h1><a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019?msockid=05311f3dde09664d0afc0b53dfa16779" title="microsoft.com">Windows Server</a> 2019 | <a href="https://learn.microsoft.com/en-us/windows-server/">Docs</a></h1>

<h2>Overview</h2>

<p>Windows Server remains the industry standard domain controller for IdP (AD DS), IdM (AD UAC), X.509 (AD CS), DNS and DHCP. Linux (RHEL) hosts join into its domain via realm and SSSD.</p>

<p>However, engineers quickly learn that its prominence is due to clever vendor lock-in rather than any technological edge. In fact, WS2019 does not allow for any sort of automation, nonetheless DevOps/GitOps methods. Every domain becomes a handcrafted boutique; a once-per-universe configuration that will never, indeed can never, be repeated again. And the man hours required to craft one, even only to the point that it is tolerably sufficient, is gargantuan. As is its maintenance.</p>

<p>Vendor marketing:</p>

<p><em>&hellip; the operating system that bridges on-premises environments
with Azure services enabling hybrid scenarios maximizing existing investments.
Create cloud native and modernize traditional apps using containers and micro-services.</em></p>

<p>That last sentence is laughable. Enterprises are slowly escaping the Windows hellscape, and moving to a purely K8s-based infra. Though very slowly.</p>

<h3>Installation options (2016/2019):</h3>

<ul>
<li><strong>Server Core</strong> (headless):<br>
This is the <strong>recommended</strong> installation option.
Itâ€™s a smaller installation that includes the core components of Windows Server
and supports all server roles but <strong>does not include a local graphical user interface</strong> (GUI).
<em>Managed remotely</em> through <strong>Windows Admin Center</strong>, PowerShell, or other server management tools.</li>
<li><strong>Server with Desktop Experience</strong> : <strong>Server Manager</strong> (GUI):<br>
This is the complete installation and includes a full GUI for customers who prefer this option.</li>
</ul>

<h3>Three Versions</h3>

<ul>
<li><strong>Datacenter</strong> : Virtual Machine for Cloud environments

<ul>
<li><a href="https://1337x.to/torrent/4212270/Windows-Server-2019-DataCenter-3in1-ESD-en-US-DEC-2019-Gen2/">https://1337x.to/torrent/4212270/Windows-Server-2019-DataCenter-3in1-ESD-en-US-DEC-2019-Gen2/</a></li>
</ul></li>
<li><strong>Standard</strong> : Physical server or minimally-virtualized environments</li>
<li><strong>Essentials</strong> : Small biz up to 25 users and 50 devices</li>
</ul>

<p>Requirements:</p>

<ul>
<li>CPU: 1 1.4 GHz</li>
<li>RAM: 512 MB</li>
<li>Disk: 32 GB</li>
</ul>

<h3><a href="https://learn.microsoft.com/en-us/windows-server/manage/windows-admin-center/overview">Windows Admin Center</a> (WAC)</h3>

<p>A locally-deployed, <strong>browser-based management tool</strong> set built to manage Windows Clients, Servers, and Clusters without needing to connect to the cloud. Windows Admin Center offers full control over all aspects of Windows-based server infrastructure and is <strong>particularly useful for managing on-prem servers</strong>.</p>

<p>WAC <strong>requires its own separate installation</strong>.WAC is not a built-in feature of WS2019.<br>
While it is designed to manage Windows Server environments, WAC itself is a web-based management tool that must be downloaded and installed manually.</p>

<p>Once installed, you can <strong>use WAC to manage multiple Windows Servers, Hyper-V hosts, clusters, and even Windows 10 and 11 PCs</strong> from a single web-based interface. It simplifies server management tasks by centralizing the management tools and offering a modern, unified experience.
You can install WAC on a Windows Server or Windows client and access it via a web browser.
It can also be deployed in a high-availability setup in larger environments.</p>

<h2>Realm v. Domain v. Forest v. Tree</h2>

<h3>ðŸ”¹ <strong>Active Directory Terminology</strong></h3>

<table>
<thead>
<tr>
<th>Concept</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td><strong>Domain</strong></td>
<td>A logical grouping of objects (users, computers, etc.) under a single database and namespace (e.g., <code>example.com</code>).</td>
</tr>

<tr>
<td><strong>Forest</strong></td>
<td>A collection of one or more domains that share a common schema and global catalog, with implicit trust.</td>
</tr>

<tr>
<td><strong>Tree</strong></td>
<td>A collection of domains in a <strong>contiguous namespace</strong> within a forest.</td>
</tr>
</tbody>
</table>

<ul>
<li>Domains in a forest can trust each other automatically.</li>
<li>A forest is the <strong>security boundary</strong>.</li>
</ul>

<hr>

<h3>ðŸ”¹ <strong>Kerberos Terminology</strong></h3>

<table>
<thead>
<tr>
<th>Concept</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td><strong>Realm</strong></td>
<td>A Kerberos concept, representing an authentication boundaryâ€”usually maps 1:1 to an AD domain and written in <strong>ALL CAPS</strong> (e.g., <code>EXAMPLE.COM</code>).</td>
</tr>
</tbody>
</table>

<ul>
<li>In practice, <strong>AD Domain = Kerberos Realm</strong> (case-insensitive match, but usually uppercase in Kerberos tools).</li>
<li>When using Linux/SSSD/Kerberos to integrate with AD, you configure a <code>realm</code> like <code>EXAMPLE.COM</code>, which corresponds to the AD domain <code>example.com</code>.</li>
</ul>

<hr>

<h3>ðŸ§­ Where They Intersect</h3>

<table>
<thead>
<tr>
<th>Term</th>
<th>Found In</th>
<th>Example</th>
</tr>
</thead>

<tbody>
<tr>
<td><strong>Domain</strong></td>
<td>AD</td>
<td><code>ad.lan</code></td>
</tr>

<tr>
<td><strong>Forest</strong></td>
<td>AD</td>
<td><code>ad.lan</code>, <code>corp.ad.lan</code> â†’ part of the same forest</td>
</tr>

<tr>
<td><strong>Realm</strong></td>
<td>Kerberos</td>
<td><code>AD.LAN</code> (used in krb5.conf, SSSD, etc.)</td>
</tr>
</tbody>
</table>

<ul>
<li><p><strong>In Linux config (e.g., <code>/etc/krb5.conf</code>, SSSD)</strong>:</p>

<pre><code class="language-ini">[realms]
AD.LAN = {
  kdc = dc1.ad.lan
  admin_server = dc1.ad.lan
}
</code></pre>

<p>Here, the Kerberos <code>REALM</code> refers to the AD <strong>domain</strong>.</p></li>
</ul>

<hr>

<h3>ðŸ§© Summary</h3>

<table>
<thead>
<tr>
<th>Term</th>
<th>Role</th>
<th>Example</th>
<th>Scope</th>
</tr>
</thead>

<tbody>
<tr>
<td>Domain</td>
<td>Logical container</td>
<td><code>example.com</code></td>
<td>One namespace</td>
</tr>

<tr>
<td>Forest</td>
<td>Trust boundary</td>
<td>multiple domains</td>
<td>Entire AD</td>
</tr>

<tr>
<td>Realm</td>
<td>Auth boundary</td>
<td><code>EXAMPLE.COM</code></td>
<td>Often = Domain</td>
</tr>
</tbody>
</table>

<p>Let me know if you want to map this to a Linux config or see how realm joins work.</p>

<h2>Roles/Features</h2>

<p>Selectable by checkbox at the AD Installation Wizard of the Server Manager GUI</p>

<ul>
<li>DHCP Server</li>
<li>DNS Server</li>
<li><strong>Active Directory</strong> | <a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc736627(v=ws.10)">Directory data store</a> | <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/powershell/active-directory-replication-and-topology-management-using-windows-powershell">Manage by PowerShell AD Module</a>

<ul>
<li><strong>Domain Services</strong> (<a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview">AD DS</a>) | <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/component-updates/ad-ds-operations">Operations</a></li>
<li><strong>Federation Service</strong> (<a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/ad-fs-overview">AD FS</a>)<br>
AD FS enables <strong>Federated Identity</strong> and <strong>Access Management</strong> by securely sharing digital identity and entitlements rights across security and enterprise boundaries. Implements OIDC, and OAuth Grant flows. Successor is Microsoft Entra ID.

<ul>
<li><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/overview/ad-fs-openid-connect-oauth-flows-scenarios">AD FS OIDC/OAuth Flows v. App Scenarios</a></li>
<li>DEPRICATED : Microsoft is hard selling its cloud service <a href="https://learn.microsoft.com/en-us/entra/fundamentals/whatis">Entra ID</a> which mates to its labyrinth of proprietary apps, each designed to superglue customers to Microsoft Corporation.</li>
</ul></li>
<li><strong>Certificate Services</strong> (<a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-cs/active-directory-certificate-services-overview#key-features">AD CS</a>)<br>
Issue and manages TLS certificates via web UI. Provides Public Key Infrastructure (PKI)
for cryptography, digital certificates and signature capabilities.</li>
</ul></li>
<li>PowerShell Desired State Configuration (DSC) in Windows Management Framework (WMF) 5<br>
Windows Management Framework 5 includes updates
to Windows PowerShell Desired State Configuration (DSC),
Windows Remote Management (WinRM),
and Windows Management Instrumentation (WMI).</li>
<li><a href="https://learn.microsoft.com/en-us/training/modules/manage-windows-server-file-servers/?source=recommendations">Manage Windows Server file servers</a> : In AD DS environment having a domain member configured as a file server.</li>
<li>Deploy Network File System (NFS)

<ul>
<li><a href="https://learn.microsoft.com/en-us/windows-server/storage/nfs/deploy-nfs#provision-file-shares-in-heterogeneous-environments">Provision file shares in heterogenous environments</a> : SMB &amp; NFS protocols for file shares between Windows and Linux hosts. For this scenario, you <strong>must have a valid identity mapping</strong> source configuration. Windows Server supports the following <strong>identity mapping stores</strong>:

<ul>
<li>Mapping File</li>
<li>Active Directory Domain Services (AD DS)</li>
<li>RFC 2307-compliant LDAP stores such as Active Directory Lightweight Directory Services (AD LDS)</li>
<li>User Name Mapping (UNM) server</li>
</ul></li>
<li><a href="https://learn.microsoft.com/en-us/windows-server/storage/nfs/deploy-nfs#provision-file-shares-in-unix-based-environments">Provision file shares in UNIX-based environments</a> : No share between Windows and Linux. Enabling the option, <strong>Unmapped UNIX User Access</strong> (UUUA) enables Windows servers to store NFS data without creating UNIX-to-Windows account mapping. &hellip; to quickly provision and deploy NFS sans mapping.

<ul>
<li>Mapped user accounts use standard Windows SIDs</li>
<li>Unmapped user accounts use custom NFS SIDs.</li>
</ul></li>
<li><a href="https://learn.microsoft.com/en-us/windows-server/storage/nfs/deploy-nfs#configure-nfs-authentication">Configure NFS Authentication</a> :

<ul>
<li>Kerberos v5

<ul>
<li>Krb5: to authenticate users before granting them access to the file share.</li>
<li>Krb5i: to authenticate with integrity checking (checksums),
which verifies that the data hasn't been altered.</li>
<li>Krb5p: to authenticate NFS traffic with encryption for privacy.
This option is the most secure Kerberos option.</li>
</ul></li>
<li>Enable <strong>unmapped user access</strong> through <code>AUTH_SYS</code>. This option is insecure; it removes all authentication protections and <strong>allows any user with access to the NFS server to access data</strong> under one of two settings:

<ul>
<li>Allow unmapped user access by UID or GID, which is the default.</li>
<li>Allow anonymous access.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<h2>Hyper-V Prep</h2>

<p>Networking : Connectivity between WSL2 &amp; Hyper-V VMs</p>

<h3>The NAT subnet option : <a href="https://chatgpt.com/share/67391a83-bdbc-8009-99fb-d69281826092" title="ChatGPT">Overview of best options</a></h3>

<p>@ <a href="network-nat.ps1"><code>network-nat.ps1</code></a></p>

<p>See params it configured by running <a href="network-get.ps1"><code>network-get.ps1</code></a></p>

<ol>
<li>User above script or Hyper-V GUI to create the Internal Switch (<code>InternalSwitchNAT1</code>)

<ul>
<li>PowerShell script above creates the switch if not exist, yet using it to do so prior to finding the packet-forwarding solution mentioned below resulted in failure of connectivity tests.</li>
<li>Isolated, this is initally/automatically assigned an APIPA address</li>
</ul></li>

<li><p>Use PowerShell to <strong>create the <code>NAT1</code> subnet</strong> (<code>192.168.11.0/24</code>)
having <strong>route to WSL subnet</strong> (<code>172.27.240.0/20</code>) <strong>gateway</strong>.</p>

<pre><code class="language-powershell">New-NetNat -Name &quot;$NatName&quot; -InternalIPInterfaceAddressPrefix &quot;$NatCIDR&quot;
Set-NetIPAddress -InterfaceAlias &quot;$WslAlias&quot; -IPAddress &quot;$WslGateway&quot; -PrefixLength 20 
</code></pre></li>

<li><p>Use <code>ncpa.cpl</code> (GUI) to manually set
IP address within our declared <code>NAT1</code> CIDR
on <code>$NatAlias</code> interface (<code>InternalSwitchNAT1</code>).</p></li>

<li><p><strong>Enable IP packet forwarding</strong>, per adapter (switch),
to provide connectivity across subnets.</p>

<pre><code class="language-powershell"># Enable IP packet forwarding (across subnets) : Per adapter
Set-NetIPInterface -InterfaceAlias &quot;$ExtAlias&quot; -Forwarding Enabled -Verbose
Set-NetIPInterface -InterfaceAlias &quot;$WslAlias&quot; -Forwarding Enabled -Verbose
Set-NetIPInterface -InterfaceAlias &quot;$DefAlias&quot; -Forwarding Enabled -Verbose
Set-NetIPInterface -InterfaceAlias &quot;$NatAlias&quot; -Forwarding Enabled -Verbose
# Else all at once
Get-NetIPInterface | Where-Object {$_.InterfaceAlias -like 'vEthernet (*' } | Set-NetIPInterface -Forwarding Enabled

</code></pre></li>
</ol>

<p>WSL2 has connectivity to Windows 11 host (<code>External</code>) network regardless;
however, NAT subnet does not until packet forwarding is enabled.</p>

<p><strong>Verify connectivity</strong> from WSL2 to NAT1 subnet;
route between <code>Ubuntu</code> (WSL2) host and <code>a0.lime.lan</code> (NAT1) host:</p>

<pre><code class="language-bash">Ubuntu [13:23:45] [1] [#0] /c/TEMP
â˜© traceroute a0.lime.lan
traceroute to a0.lime.lan (192.168.11.104), 64 hops max
1   172.24.208.1  0.432ms  0.227ms  0.139ms    # WSL Gateway
2   192.168.11.104  0.448ms  0.230ms  0.287ms  # Target Hyper-V VM host
</code></pre>

<p>To test NAT1 prior to provisioning DHCP/DNS server on that subnet,
manually add the IP and route on that CIDR to the host's network device.
This task is performed from a Hyper-V Connect session:</p>

<pre><code class="language-bash"># Manually assign IP within NAT1 CIDR
sudo ip addr add 192.168.11.111/24 dev eth0

# Add default gatewayy (The IPv4 declared at NAT1 adapter) 
sudo ip route add default via 192.168.11.1

</code></pre>

<p>Now test @ WSL:</p>

<pre><code class="language-bash">â˜© traceroute 192.168.11.111
traceroute to 192.168.11.111 (192.168.11.111), 64 hops max
  1   172.27.240.1  0.361ms  0.175ms  0.160ms
  2   192.168.11.111  0.326ms  0.231ms  0.164ms
</code></pre>

<p><strong><em>Success!</em></strong></p>

<h3>Add local DNS for best performance:</h3>

<p>@ <a href="network-dns.ps1"><code>network-dns.ps1</code></a></p>

<p>Keep the default DNS configuration of WSL2 host:</p>

<pre><code class="language-bash">...
# DNS @ WSL2 network is best handled automatically, 
# which auto-generates /etc/resolv.conf
# The nameserver is set to WSL's virtual DNS server (10.255.255.254)
# And it sets the default search domain for unqualified dowmain names:
# â˜© cat /etc/resolv.conf
# ...
# nameserver 10.255.255.254
# search SEMPERLAN hsd1.md.comcast.net
</code></pre>

<ul>
<li>See <a href="network-dns.ps1"><code>network-dns.ps1</code></a></li>
</ul>

<h2>Create VM of Hyper-V</h2>

<ul>
<li>Generation: <code>2</code></li>
<li>Name: <code>WinSrv2019</code></li>
<li>CPU: <code>2</code></li>
<li>RAM: <code>2048-4096</code> MiB (Dynamic)</li>
<li>Network: <code>InternalSwitchNAT1</code>

<ul>
<li>If <code>External...</code>, then has DHCP issue.
See below: &quot;DNS Options&quot; WARNING under &quot;Domain Controller Options&quot;, and <a href="https://chatgpt.com/share/670c59f1-7504-8009-beea-ff2f8d4caff9">ChatGPT</a> .</li>
</ul></li>
<li>Integration Services

<ul>
<li>Guest services (check)</li>
<li>All should be checked.</li>
</ul></li>
<li>Disk: <code>0-32 GB</code> (Dynamic)

<ul>
<li><code>14 GB</code> after install.</li>
</ul></li>
<li>ISO: <code>SRV2019STD.ENU.NOV2022.iso</code>

<ul>
<li>&quot;<strong>Windows Server 2019 Standard</strong> 1809 Build 17763.3650 en-US ESD NOV 2022&quot;</li>
</ul></li>
</ul>

<h2>Install Windows Server 2019</h2>

<h3>WARNING:</h3>

<p>Boot from ISO fails when installing Windows Server 2019 host on Hyper-V VM is using the Start button from Hyper-V menu. Rather, <strong>select Connect option, and press Start button only from inside that window.</strong> This method captures the keyboard, allowing OS install on &quot;Press any key &hellip;&quot;.</p>

<p><strong>Any other method bricks the VM.</strong></p>

<h3>Windows Server Install</h3>

<ol>
<li><strong>Connect</strong>

<ul>
<li>Options : Local Resources : More : Drives : Scratch (S:) or whatever to <strong>share drive(s) between host and VM</strong>.</li>
<li>Save conguration (checkbox)</li>
</ul></li>
<li><strong>Start</strong> (button in the Connect window)

<ul>
<li>&quot;GENERATION<sup>2</sup>&quot; screen displays</li>
<li><strong>Windows Setup</strong> window (eventually) appears

<ul>
<li>Install option: &quot;Custom ...&quot; is the only viable/allowable.</li>
<li>Without Guest services of Settings menu, disk size is hardcoded to 127 GB. No options. ISO has no drivers.</li>
<li>&quot;Customize settings&quot;

<ul>
<li>&quot;User name: <strong>Administrator</strong>&quot; (hardcoded)</li>
<li>Password: <strong>Admin!123</strong></li>
</ul></li>
</ul></li>
<li>Shutdown

<ul>
<li>Merge at Hyper-V takes many minutes.</li>
</ul></li>
</ul></li>
<li><strong>Remove DVD</strong> at Hyper-V Settings.</li>
<li>Connect/Start

<ul>
<li>Boots into Server Manager

<ul>
<li>Enter password</li>
<li>Local Server</li>
</ul></li>
</ul></li>
</ol>

<h3>Activate @ &quot;Not Activated&quot;</h3>

<p>How to <strong>Activate via KMS</strong> using <a href="https://github.com/massgravel/Microsoft-Activation-Scripts" title="GitHub.com">Microsoft Activation Scripts (MAS)</a> method at a PowerShell terminal:</p>

<pre><code class="language-powershell">Install-WindowsFeature -Name VolumeActivation -IncludeManagementTools

# Run this statement and select the &quot;KMS&quot; option at its menu
irm https://get.activated.win | iex
</code></pre>

<h3>Disable MS Online Account Sign-in Requirement</h3>

<p>The default OS install has a &quot;Welcome&quot; login
sequence requiring a Microsoft account.
It blocks user from login until user signs up for MS account,
enters creds of existing account,
or selects a button that is effectively a
&quot;Repeatedly block and bother me again later&quot;.</p>

<p>This statement cures that:</p>

<pre><code class="language-powershell">Set-ItemProperty -Path &quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; -Name &quot;NoConnectedUser&quot; -Value 3 -Type DWord

</code></pre>

<h2>Configure Windows Server</h2>

<ol>
<li><strong>Ethernet adapter</strong> (<code>ncpa.cpl</code>)

<ul>
<li>Reference the network (<code>InternalSwitchNAT1</code>) <strong>installed earlier</strong><br>
in a PowerShell session at the host (Windows 11) :<br>

<ul>
<li><a href="network-nat.ps1"><code>network-nat.ps1</code></a></li>
<li><a href="network-define.ps1"><code>network-define.ps1</code></a></li>
<li><a href="network-get.ps1"><code>network-get.ps1</code></a></li>
</ul></li>
<li>Ethernet adapter configuration:

<ul>
<li>Properties:

<ul>
<li>IPv6 (Uncheck)</li>
<li>IPv4 (check) : Properties:

<ul>
<li>&quot;Use the following IP address&quot; (check)

<ul>
<li>IP address: <code>192.168.11.2</code> (Self)</li>
<li>Subnet mask: <code>255.255.255.0</code> (<code>24</code> bit)</li>
<li>Default gateway: <code>192.168.11.1</code> (NAT1 IPv4)</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Local Server</strong>

<ul>
<li>Computer name: <strong><code>dc1</code></strong> (Domain Controller 1)</li>
<li>Ethernet: <strong><code>192.168.11.2</code></strong>

<ul>
<li>Set static IP to that declared at
subnet (<code>InternalSwitchNAT1</code>) configured earlier.</li>
</ul></li>
<li>Time zone: <code>Eastern</code></li>
<li>IE Enhanced Security Configuration: <code>Off</code> (All)

<ul>
<li>IE Enhanced Security Configuration

<ul>
<li>Off @ Admin</li>
<li>Off @ User</li>
</ul></li>
<li>Time zone : Change : EST</li>
</ul></li>
</ul></li>
</ol>

<blockquote>
<p><strong>Server Manager</strong> is the GUI and main
portal of <strong>Windows&nbsp;Server&nbsp;2019</strong> Desktop.
<a href="https://www.microsoft.com/en-us/windows-server/windows-admin-center?msockid=05311f3dde09664d0afc0b53dfa16779" title="microsoft.com">Windows Admin Center</a> (WAC)&quot; is a web UI providing remote access to the server.
It is installed separately,
either on the AD server or any remote host</p>
</blockquote>

<h2>Share Files between Host and VM</h2>

<p>How to add network share(s):</p>

<ul>
<li>@ Hyper-V Settings : Enable &quot;<strong>Enhanced Sesison Mode</strong>&quot;</li>
<li>@ VM Settings : Integration Services : Check &quot;<strong>Guest Services</strong>&quot;</li>
<li>@ Connect : &quot;<strong>Local devices and resources</strong>&quot; :
Button: <strong>More...</strong>  : Checkbox: &quot;<strong>Scratch (S:)</strong>&quot;
and/or whatever other drive is to be shared.</li>
</ul>

<h2>Add Roles</h2>

<ol>
<li>Open <strong>Server Manager</strong>.</li>
<li>Click <strong>Manage</strong> and select <strong>Add Roles and Features</strong>.</li>
<li>In the <strong>Add Roles and Features Wizard</strong>:

<ul>
<li>Click <strong>Next</strong> through the default screens :<br>
&quot;<strong>Role-based or feature-based installation</strong>&quot;.</li>
<li>Select sever ...</li>
<li>At <strong>Server Roles</strong> screen, select whatever role(s)</li>
<li>Click <strong>Next</strong> and proceed with the installation.</li>
</ul></li>
<li>After installation, you'll be prompted to <strong>Complete $hellip; Configuration</strong>.
Click on the notification to complete.</li>
</ol>

<h3>ADDS and DNS</h3>

<blockquote>
<p>Adding the <strong>Active Directory Domain Services</strong> (ADDS) role by Wizard adds the required DNS role, so need select only the ADDS role.</p>
</blockquote>

<p>Reference video: &quot;<a href="https://www.youtube.com/watch?v=joIubWzQ6P8" title="YouTube.com">Installing Active Directory Domain Services in Windows Server 2022, along with DNS and DHCP</a>&quot;</p>

<h4><a href="https://www.youtube.com/watch?v=0EklBDIZSgc&amp;list=PLxTwjzMO9Zf4FZJ0BTtQlv5iErouqkbkk&amp;index=2">Add <strong>ADDS</strong> Role</a> (and <strong>DNS</strong> role too) :</h4>

<p>Use the Wizard</p>

<ul>
<li>Add server role:

<ul>
<li>Server Manager : Manage : Add Roles and Features

<ul>
<li>Active Directory Directory Services</li>
</ul></li>
</ul></li>
<li>Windows Update

<ul>
<li>This interrupted the workflow during promotion (below).</li>
</ul></li>
<li>Promote server to DC:

<ul>
<li>Promote this server to a domain controller<br>
&vellip;</li>
</ul></li>
<li>Reboot</li>
<li>Promote server to DC:

<ul>
<li>Promote this server to a domain controller

<ul>
<li>Deployment Configuration

<ul>
<li><strong>New forest</strong></li>
<li>Root domain name: <strong><code>lime.lan</code></strong></li>
<li>Restore-mode password: <code>Admin!123</code></li>
</ul></li>
<li>Domain Controller Options

<ul>
<li>Forest functional level: Windows Server 2016 (From drop-down menu)</li>
<li>Domain functional level: Windows Server 2016 (From drop-down menu)

<ul>
<li>Assure compatibility w/ existing Forest/Domain</li>
<li>DNS Options (If not using this as DNS server)

<ul>
<li>WARNING: A delegation for this DNS server cannot be created because authoritative parent zone cannot be found or it does not run Windows DNS infrastructure. If you are integrating with an existing DNS infrastructure, you should manually create a delegation to this DNS server in the parent zone to ensure reliable name resolution from outside the domain <code>lime.lan</code>.

<ul>
<li>Ignore else reconfigure networking. See <a href="https://chatgpt.com/share/670c59f1-7504-8009-beea-ff2f8d4caff9">ChatGPT</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<h4>Configure DNS</h4>

<p>ADDS Wizard configures Forward Lookup Zone, but not Revers.</p>

<ol>
<li>Open <strong>DNS Manager</strong> (<code>dnsmgmt.msc</code>).</li>
<li>Right-click the server and select <strong>Configure a DNS Server</strong>.

<ul>
<li>Select <strong>Create a Forward Lookup Zone</strong>.</li>
<li>Name the zone something relevant to your internal network (e.g., <strong><code>lime.lan</code></strong>).</li>
<li>Set the DNS server to use <strong>forwarders</strong> for external lookups (e.g., point it to <code>8.8.8.8</code> for Google DNS or your preferred DNS servers).</li>
</ul></li>
</ol>

<p>Create a <strong>Reverse Lookup Zone</strong>.
The primary reverse lookup zone needs a pointer (<code>PTR</code>) record.
The ADDS Wizard does not do this for us.</p>

<ul>
<li>Create Primary Zone</li>
<li>Add Network Addr</li>
<li>Resolve</li>
<li>Update PTR in Forward Record</li>
</ul>

<h4>DNS @ ADDS : <code>&quot;_msdcs.&lt;domain&gt;&quot;</code></h4>

<p>The <code>&quot;_msdcs.&lt;domain&gt;&quot;</code> zone created during the Active Directory Domain Services (AD DS) integration with the DNS role (via Wizard) is a critical component of AD DS's dynamic DNS infrastructure.  It enables seamless communication and operation of the AD environment by providing a dynamically updated repository of service location information.</p>

<ul>
<li>Automatically <strong>created as a forward lookup zone</strong> if it doesn't exist.

<ul>
<li>Configured to replicate across all DNS servers in the forest if the domain is part of a larger forest.</li>
<li>Ensures that critical DNS data is available across all DNS servers, improving redundancy and fault tolerance.</li>
</ul></li>
<li>What is <code>_msdcs.&lt;domain&gt;</code>?

<ul>
<li><strong>Namespace for Active Directory Services</strong>:

<ul>
<li><code>_msdcs</code> stands for &quot;Microsoft Domain Controller Services.&quot;</li>
<li>This zone contains service locator (SRV) records and other essential DNS entries used by Active Directory to locate domain controllers and other AD services.</li>
</ul></li>
<li><strong>Globally Unique Identifier (GUID) Records</strong>:

<ul>
<li>Each domain controller in an AD forest is assigned a unique GUID. These GUIDs are stored in the <code>_msdcs</code> zone to allow clients to find specific domain controllers in the forest.</li>
</ul></li>
<li><strong>Forest-wide Locator Records</strong>:

<ul>
<li><code>_msdcs.&lt;domain&gt;</code> includes records that are forest-wide, meaning they are necessary for locating services across the entire forest, not just within a single domain.</li>
</ul></li>
</ul></li>
<li>Key Features of <code>_msdcs.&lt;domain&gt;</code>

<ul>
<li><strong>Service Locator (SRV) Records</strong>:</li>
<li>The zone holds SRV records that direct clients to domain controllers for authentication, replication, and other AD services.</li>
<li>Example: <code>_ldap._tcp.dc._msdcs.lime.lan</code> directs LDAP clients to a domain controller in the lime.lan domain.</li>
<li><strong>Alias Records (CNAME)</strong>:</li>
<li>It includes CNAME records that map GUIDs to domain controllers.</li>
<li>Example: <code>&lt;DC-GUID&gt;._msdcs.lime.lan</code> helps clients locate a specific domain controller.</li>
</ul></li>
<li><strong>Forest Root Information</strong>:

<ul>
<li>In multi-domain forests, <code>_msdcs.&lt;forest-root&gt;</code> is shared across domains to ensure inter-domain operations, such as trust relationships and global catalog searches.</li>
</ul></li>
<li>Importance in AD DS Functionality

<ul>
<li><strong>Client Authentication</strong>: Without <code>_msdcs</code>, clients wouldn't know which domain controller to contact for login authentication.</li>
<li><strong>Replication</strong>: Domain controllers rely on <code>_msdcs</code> to locate replication partners.</li>
<li><strong>Global Catalog Services</strong>: Used for locating global catalog servers across the forest.</li>
</ul></li>
<li>Management Considerations

<ul>
<li><strong>Replication Scope</strong>:

<ul>
<li>By default, the <code>_msdcs.&lt;domain&gt;</code> zone is stored in the forest-wide DNS application partition.</li>
<li>Ensure that replication is correctly configured to all DNS servers in the forest.</li>
</ul></li>
<li><strong>Do Not Modify Manually</strong>:

<ul>
<li>The records in <code>_msdcs</code> are automatically maintained by AD DS. Avoid manual changes to prevent breaking critical AD operations.</li>
</ul></li>
</ul></li>
</ul>

<h2>ADD DHCP Role</h2>

<p>Use the Wizard</p>

<p><strong><a href="https://learn.microsoft.com/en-us/windows-server/networking/technologies/dhcp/quickstart-install-configure-dhcp-server?tabs=powershell" title="learn.microsoft.com">Configure DHCP</a></strong></p>

<p>@ PowerShell</p>

<p>XML scripts exported from Wizards allow for scripted configuration, either again here, or on other hosts:</p>

<pre><code class="language-powershell">
$dns    = &quot;DNS.DeploymentConfigTemplate.xml&quot;
Windows-Feature -ConfigurationFilePath $dns

$dhcp   = &quot;DHCP.DeploymentConfigTemplate.xml&quot;
Windows-Feature -ConfigurationFilePath $dhcp
</code></pre>

<p>Separately, this is is a PowerShell method of scripting the DHCP server. It is cobbled together from references:</p>

<pre><code class="language-powershell">$NatNtwk    = &quot;192.168.11&quot;
$HostName   = &quot;dc1.lime.lan&quot;
$NatDNS     = &quot;$NatNtwk.2&quot;

# These first statements are performed by the Add-Role Wizard
Install-WindowsFeature DHCP -IncludeManagementTools
Add-DhcpServerSecurityGroup -ComputerName &quot;$HostName&quot; 
netsh dhcp add securitygroups
# If in ADDS
Add-DhcpServerInDC -DnsName &quot;$hostName&quot; -IPAddress &quot;$NatDNS&quot; -PassThru

# The following statements may be run *after* the above objects exist.

# Create/Define Scope
Add-DhcpServerv4Scope -Name &quot;lime.lan&quot; `
    -StartRange &quot;$NatNtwk\.100&quot; `
    -EndRange &quot;$NatNtwk\.200&quot; `
    -SubnetMask 255.255.255.0 `
    -LeaseDuration 8.00:00:00 `
    -State Active `
    -PassThru 

# Verify ADDS Authorized
Get-DhcpServerInDC
# IPAddress            DnsName
# ---------            -------
# 192.168.11.2         dc1.lime.lan

Restart-Service DHCPServer 

# Query available parameters
Get-DhcpServerv4&lt;TAB&gt;
</code></pre>

<p>@ GUI</p>

<ol>
<li>Open <strong>DHCP Manager</strong> (<code>dhcpmgmt.msc</code>).</li>
<li>Right-click on <strong>IPv4</strong> and select <strong>New Scope</strong>.

<ul>
<li><strong>Scope Name</strong>: <code>lime.lan</code>.</li>
<li><strong>IP Range</strong>: Set the IP range for the internal network. Align these with <code>InternalSwitchNAT1</code> subnet (<a href="network-nat.ps1"><code>network-nat.ps1</code></a>) parameters. See by running  <a href="network-get.ps1"><code>network-get.ps1</code></a>

<ul>
<li><strong>Start IP</strong>: <code>192.168.11.100</code></li>
<li><strong>End IP</strong>: <code>192.168.11.200</code></li>
<li><strong>Subnet Mask</strong>: <code>255.255.255.0</code></li>
</ul></li>
<li><strong>Default Gateway</strong>: Set this to the <strong>vEthernet</strong> interface on the host (<code>192.168.11.1</code>).</li>
<li><strong>DNS</strong>: Set to this Windows Server IP, since it's the DNS server for our internal network. We set this to <code>192.168.11.2</code>; static IP at Windows Server's Local Server menu, aligned with delcared subnet params. See PowerShell scripts.

<ul>
<li>Manually set it.</li>
</ul></li>
</ul></li>
<li><strong>Activate the Scope</strong>.

<ul>
<li>Right-click the new scope and click <strong>Activate</strong>.</li>
</ul></li>
</ol>

<p>To get a new IP address from DHCP:</p>

<ul>
<li><strong>Windows</strong>: Use <code>ipconfig /release</code> and <code>ipconfig /renew</code>.</li>
<li><strong>RHEL</strong>: Restart the network service with <code>sudo systemctl restart network</code>.</li>
</ul>

<p>Other tasks:</p>

<ul>
<li>Secondary Domain Controller:</li>
<li>Read-only Domain Controller (RODC)</li>
</ul>

<h2>Active Directory Users and Computers (<strong>ADUC</strong>)</h2>

<p>In AD, there's a <strong>built-in container</strong> named <code>CN=Users</code>,
which is not technically an OU.
Rather it's just a default container for user accounts and groups created during domain setup.</p>

<p><strong>Built-in Containers</strong></p>

<pre><code>lime.lan
â””â”€â”€ Users (CN=Users, DC=lime, DC=lan)
    â”œâ”€â”€ Administrator
    â”œâ”€â”€ Domain Admins
    â”œâ”€â”€ Domain Users
    â”œâ”€â”€ Guest
    â””â”€â”€ Other default groups/accounts
</code></pre>

<p><strong>OUs</strong> (<strong>Organizational Units</strong>) are those we create:</p>

<pre><code>lime.lan
â””â”€â”€ OU1 (OU=OU1,DC=lime,DC=lan)
    â”œâ”€â”€ IT
    â”œâ”€â”€ DevOps
    â””â”€â”€ OU1-01
</code></pre>

<ul>
<li>Group Policies can be linked to OUs.</li>
<li>Administrative permissions may be delegated to (groups and users in) OUs.

<ul>
<li>See &quot;<strong>Delegate Control</strong>&quot; section (below)</li>
</ul></li>
</ul>

<p><strong>Naming conventions</strong> for AD Groups/Users of both Windows and Linux hosts:</p>

<ul>
<li><strong>Group</strong> name

<ul>
<li><code>[ad-]linux-users</code> : Standard access</li>
<li><code>[ad-]linux-admins</code> : Host administrators</li>
<li><code>[ad-]linux-sudoers</code> : Users granted sudo access</li>
<li><code>[ad-]linux-operators</code> : Limited management of Linux hosts/services.</li>
</ul></li>
<li><strong>User</strong> name

<ul>
<li><code>alex.hamilton</code></li>
<li><code>alexhamilton</code></li>
</ul></li>
</ul>

<h3>Create <code>admin</code> User</h3>

<p>@ Server Manager : Tools : <strong>Active Directory Users and Computers</strong> (<strong>ADUC</strong>)</p>

<h4>1. Create Organizational Units (OU)</h4>

<p>Create new OU, <code>OU1</code>, and two OUs (<code>DevOps</code>, <code>IT</code>) nested under <code>OU1</code>.</p>

<ul>
<li>Active Directory Users and Computers [dc1.lime.lan]

<ul>
<li><code>lime.lan</code> (Rt Click) : New : Organizational Unit : Name: <code>OU1</code>

<ul>
<li><code>OU1</code> (Rt Click) : New : Organizational Unit : Name: <code>DevOps</code></li>
<li><code>OU1</code> (Rt Click) : New : Organizational Unit : Name: <code>IT</code></li>
</ul></li>
</ul></li>
</ul>

<p><strong>Resulting Structure</strong>:</p>

<ul>
<li>ADUC [dc1.lime.lan]

<ul>
<li>lime.lan

<ul>
<li>OU1

<ul>
<li>DevOps</li>
<li>IT</li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<h4>2. Create User</h4>

<p>An AD user has creds for authn/authz against ADDS of Windows Server 2019 (<code>DC1</code>)
at any host joined into that AD domain AKA realm.</p>

<ul>
<li><p>Active Directory Users and Computers [dc1.lime.lan]</p>

<ul>
<li><p>lime.lan (Rt Click) : New : Organizational Unit : Name: <code>OU1</code></p>

<ul>
<li><p>OU1</p>

<ul>
<li>IT (Rt Click) : New : User : New Object (Window)

<ul>
<li>First name: <code>admin</code></li>
<li>Last name:</li>
<li>Full name: <code>admin</code></li>
<li>User logon name: <code>admin</code></li>
</ul></li>
</ul>

<p>&vellip;</p></li>
</ul></li>
</ul></li>
</ul>

<p><strong>Resulting Creds</strong>:</p>

<ul>
<li>User: <code>admin</code></li>
<li>Pass: <code>Foo!123456</code></li>
</ul>

<h4>3. Add User <code>admin</code> to Group <code>Domain Admins</code></h4>

<p>Click on user <code>admin</code>, right-click <strong>Properties</strong> &gt; <strong>Member of</strong>, and <strong>Add&hellip;</strong> &gt; Select Groups &gt; <strong>Check Names</strong> &gt; type &quot;domain&quot; and select &quot;<strong>Domain Admins</strong>&quot;.</p>

<h3>Delegation : &quot;Delegate Control&quot;</h3>

<p>Delegation in AD DS refers to granting specific administrative permissions to a user or group for managing objects within an Organizational Unit (OU), without giving them full domain administrator privileges.</p>

<p>For example, if OU1 contains IT and DevOps sub-OUs, and you want IT admins to manage only the IT users and DevOps admins to manage only DevOps users, you can delegate specific administrative tasks to them without granting Domain Admin access.</p>

<p>List all</p>

<pre><code class="language-powershell">Get-ACL &quot;AD:OU=OU1,DC=lime,DC=lan&quot; | Format-List
</code></pre>

<h2>Join Windows host (<code>Win11</code>) into ADDS Domain</h2>

<p>@ Win11</p>

<ul>
<li>Verify apropos IP is assigned;<br>
it should be within range of our DHCP server<br>

<ul>
<li><code>192.168.11.&lt;100-200&gt;</code></li>
</ul></li>
<li><strong>System</strong> (window) : <strong>To rename this computer or ...</strong>

<ul>
<li><strong>Change</strong> (button)

<ul>
<li><strong>Member of</strong>

<ul>
<li><strong>Domain</strong> (checkbox) :
Enter the domain of our ADDS server:

<ul>
<li><code>lime.lan</code><br></li>
</ul></li>
</ul></li>
<li>A pop-up window prompts for <strong>credentials</strong> :<br>
Enter those of an <strong>ADDS admin</strong> user:

<ul>
<li><strong>User name</strong></li>
<li><strong>Password</strong></li>
</ul></li>
</ul></li>
</ul></li>
<li>Await confirmation</li>
<li>Reboot</li>
</ul>

<h2><a href="https://chatgpt.com/c/67427df4-6440-8009-9d12-adb9da2faa57" title="ChatGPT">Join RHEL host into ADDS Domain</a></h2>

<p><a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html-single/integrating_rhel_systems_directly_with_windows_active_directory/index" title="docs.RedHat.com">Integrating RHEL systems directly with ADDS</a></p>

<blockquote>
<p>You can join Red Hat Enterprise Linux (RHEL) hosts to an Active Directory (AD) domain by using the System Security Services Daemon (SSSD) or the Samba Winbind service to access AD resources.</p>
</blockquote>

<ul>
<li><code>sssd</code> (System Security Services Daemon (SSSD)) : For identity and authentication.

<ul>
<li>Manages Kerberos, yet more granular control may be required. See <code>/etc/krb5.conf</code></li>
</ul></li>
<li><code>realmd</code> : To detect available domains and configure the underlying systemd services.</li>
</ul>

<p>Test on RHEL8 host <code>a0.lime.lan</code>
with AD user <strong><code>admin</code></strong> member of AD group <strong>Domain Admins</strong>.</p>

<h3>Prep</h3>

<pre><code class="language-bash"># Install pkgs
all='
    realmd 
    sssd 
    sssd-tools 
    samba-common 
    samba-common-tools 
    krb5-workstation 
    oddjob 
    oddjob-mkhomedir
'
sudo dnf install -y $all

# Add services / Open ports 
systemctl is-active firewalld &amp;&amp;
cat &lt;&lt;EOH |xargs -I{} sudo firewall-cmd --permanent --add-service={}
kerberos
dns
ldap
samba
EOH

systemctl is-active firewalld &amp;&amp;
    sudo firewall-cmd --reload
</code></pre>

<p>Also required for NFS to configure Kerberos security via AD:</p>

<pre><code class="language-bash">dnf install -y krb5-workstation nfs-utils rpcbind
</code></pre>

<p>@ <strong><code>realm</code></strong> prior to join:</p>

<pre><code class="language-bash">domain=lime.lan
#sudo hostnamectl set-hostname $(hostname).$domain

dc=dc1.$domain
realm discover $dc
</code></pre>

<pre><code class="language-plaintext">lime.lan
  type: kerberos
  realm-name: LIME.LAN
  domain-name: lime.lan
  configured: no
  server-software: active-directory
  client-software: sssd
  required-package: oddjob
  required-package: oddjob-mkhomedir
  required-package: sssd
  required-package: adcli
  required-package: samba-common-tools
</code></pre>

<ul>
<li>Note: <code>configured: no</code></li>
<li>Note hostname should not be the host's FQDN,<br>
but rather <code>FQDN=$(hostname).$domain</code></li>
</ul>

<h3>Join</h3>

<p><strong>Requires an AD DS Administrator</strong> credentials</p>

<pre><code class="language-bash">u1@a0 [15:39:28] [1] [#0] ~
â˜© sudo realm join --user=Administrator $dc
Password for Administrator@LIME.LAN:

u1@a0 [15:39:51] [1] [#0] ~
â˜©
</code></pre>

<h4>Leave/Join (AD) Domain</h4>

<p>Changes at AD to <strong>Service Principal Names</strong> (SPNs),
which may be required, e.g.,
<strong>adding an NFS server</strong> that uses Kerberos,
are best <strong>handled by leaving and then rejoining</strong> the domain.
<strong>Else the new SPNs are not recognized</strong> at RHEL hosts,
as revealed at &quot;<code>klist -k /etc/krb.keytab</code>&quot;.</p>

<p>There are other methods of adding the new entries to <code>*.keytab</code>,
using PowerShell (<code>ktpass</code>) at AD server (below), but they are tedious,
so use only if necessary.</p>

<p>@ <code>u1@a0</code></p>

<pre><code class="language-bash">domain=lime.lan
dc=dc1.$domain
realm discover $dc
realm list
sudo realm leave $domain
sudo realm join --user=Administrator $dc
#&gt; Password for u1:
#&gt; Password for Administrator:
realm discover $dc
</code></pre>

<pre><code class="language-bash">â˜© realm list
lime.lan
  type: kerberos
  realm-name: LIME.LAN
  domain-name: lime.lan
  configured: kerberos-member
  server-software: active-directory
  client-software: sssd
  required-package: oddjob
  required-package: oddjob-mkhomedir
  required-package: sssd
  required-package: adcli
  required-package: samba-common-tools
  login-formats: %U@lime.lan
  login-policy: allow-realm-logins
</code></pre>

<p>Yet doing so <strong>resets all downstream configurations</strong>,
e.g., <code>/etc/sssd/sssd.conf</code></p>

<h4>Recreate Kerberos <code>*.keytab</code> having all SPNs</h4>

<p>After adding an NFS server at host <code>a0</code>,
Kerberos (<code>klist</code>) did not recognize the NFS server,
so reconfigured RHEL/AD :</p>

<ol>
<li><code>realm leave</code> at all RHEL hosts that are NFS clients</li>
<li>Run this PowerShell script at domain controller (Windows Server)</li>
<li><code>realm join</code> at all RHEL hosts that are NFS clients</li>
</ol>

<p>@ AD server</p>

<pre><code class="language-powershell">$Realm = &quot;LIME.LAN&quot;
$Domain = &quot;LIME&quot;   # NetBIOS domain name
$Machine = &quot;A0&quot;
$KeytabPath = &quot;C:\$Machine.keytab&quot;

# Get all SPNs assigned to the machine
$SPNs = setspn -L &quot;$Machine$&quot; | Select-String -Pattern &quot;^\s+\S+&quot; | ForEach-Object { $_.ToString().Trim() }

# Check if SPNs were found
if (-not $SPNs) {
    Write-Host &quot;No SPNs found for $Machine$ in domain $Realm&quot;
    exit 1
}

# Generate keytab for the first SPN (without -append)
$FirstSPN = $SPNs[0]
$FirstPrincipal = &quot;$FirstSPN@$Realm&quot;
Write-Host &quot;Adding $FirstPrincipal to keytab...&quot;
ktpass -out &quot;$KeytabPath&quot; `
    -princ $FirstPrincipal `
    -mapuser &quot;$Domain\$Machine$&quot; `
    -crypto AES256-SHA1 `
    -ptype KRB5_NT_SRV_HST `
    -pass +rndpass

# Add remaining SPNs with -append
$SPNs | Select-Object -Skip 1 | ForEach-Object {
    $SPN = $_
    $Principal = &quot;$SPN@$Realm&quot;
    Write-Host &quot;Appending $Principal to keytab...&quot;
    
    ktpass -out &quot;$KeytabPath&quot; `
        -princ $Principal `
        -mapuser &quot;$Domain\$Machine$&quot; `
        -crypto AES256-SHA1 `
        -ptype KRB5_NT_SRV_HST `
        -pass +rndpass `
        -append
}

Write-Host &quot;Keytab generated at $KeytabPath&quot;
</code></pre>

<h3>Verify Join</h3>

<ul>
<li><p><code>realm list</code></p>

<pre><code class="language-bash">u1@a0 [15:39:51] [1] [#0] ~
â˜© realm list
</code></pre>

<pre><code class="language-plaintext">lime.lan
type: kerberos
realm-name: LIME.LAN
domain-name: lime.lan
configured: kerberos-member
server-software: active-directory
client-software: sssd
required-package: oddjob
required-package: oddjob-mkhomedir
required-package: sssd
required-package: adcli
required-package: samba-common-tools
login-formats: %U@lime.lan
login-policy: allow-realm-logins

</code></pre></li>

<li><p>Note, we are now:</p>

<ul>
<li><code>configured: kerberos-member</code></li>
</ul></li>

<li><p>Subsequent <code>sssd.conf</code> mods to allow logon by <code>$user</code> (v. <code>$user@domain</code>; see below), result in change to this report:</p>

<ul>
<li>&quot;<code>login-formats: %U</code>&quot;</li>
</ul></li>
</ul>

<h3>Enable Authn via SSSD</h3>

<p>Enable and Start SSSD:<br>
Ensure SSSD is running <strong>to handle authentication</strong>:</p>

<pre><code class="language-bash">sudo systemctl enable --now sssd
</code></pre>

<p>By default, only admins can log in.</p>

<p><strong>Allow all AD users and groups of domain</strong>:</p>

<pre><code class="language-bash">sudo realm permit --all
</code></pre>

<p>Optionally, configure <strong>Home Directory Creation</strong>:<br>
If you want AD users to get home directories automatically on login:</p>

<pre><code class="language-bash">sudo systemctl enable --now oddjobd
</code></pre>

<h4><code>oddjob</code></h4>

<p>Allows for other-than-default configuration AD users:</p>

<ul>
<li><code>HOME</code> directory at <code>/home/&lt;user&gt;</code> v. <code>/home/&lt;user&gt;@&lt;doman&gt;</code></li>
<li>SSH by &quot;<code>ssh &lt;user&gt;@&lt;host&gt;</code>&quot; v. &quot;<code>ssh &lt;user&gt;@&lt;domain&gt;@&lt;host&gt;</code>&quot;</li>
</ul>

<p>Configure</p>

<p>@ <code>/etc/sssd/sssd.conf</code></p>

<pre><code class="language-ini">...
[domain/lime.lan]
...
fallback_homedir = /home/%u
use_fully_qualified_names = False
...
</code></pre>

<p>Verify</p>

<pre><code class="language-bash">â˜© ansibash sudo cat /etc/sssd/sssd.conf 2&gt;/dev/null \
    |grep -e == -e use_fully_qualified_names -e fallback_
=== u2@a0
fallback_homedir = /home/%u
use_fully_qualified_names = False
=== u2@a1
fallback_homedir = /home/%u
use_fully_qualified_names = False
=== u2@a2
fallback_homedir = /home/%u
use_fully_qualified_names = False
=== u2@a3
fallback_homedir = /home/%u
use_fully_qualified_names = False
</code></pre>

<pre><code class="language-bash">â˜© ssh u2@a1
Last login: Fri Mar 14 08:05:44 2025 from 172.24.217.171
@ /home/u2/.bash_functions
@ /home/u2/.bashrc_git
@ /home/u2/.bashrc_k8s
@ /home/u2/.bashrc_vim
@ /home/u2/.bashrc
@ /home/u2/.bash_profile
u2@a1 [08:30:15] [1] [#0] ~
</code></pre>

<h3>Create AD User</h3>

<p>Or add the existing RHEL user to AD (not advised).
Either way, use <strong>Windows Server</strong> tool <strong>AD UAC</strong> (AD Users and Computers).</p>

<h4>AD UAC</h4>

<ul>
<li>Verify host is joined into domain

<ul>
<li>AD UAC &gt; lime.lan &gt; Computers<br>
Lists the hostname (uppercase) of all hosts in that AD realm (<code>lime.lan</code>)</li>
</ul></li>
<li>Create AD User

<ul>
<li>User: <code>u2</code></li>
<li>Pass: <code>User!123</code></li>
</ul></li>
<li>Add to AD Group(s)

<ul>
<li>If AD DS users are also Linux users, then create groups and reset the user's primary AD group:

<ul>
<li><code>linux-sudoers</code></li>
<li><strong><code>linux-users</code></strong></li>
</ul></li>
</ul></li>
<li>Reset primary group of new AD User to <code>linux-users</code>

<ul>
<li>Default is &quot;Domain Users&quot;, which is not advised for users of Linux hosts.</li>
</ul></li>
</ul>

<p>Then &hellip;</p>

<p><strong>Allow SSH by &quot;<code>ssh $user@$host</code>&quot; instead of requiring &quot;<code>ssh $user@$domain@$host</code>&quot; for AD DC users</strong>:</p>

<p>@ <code>/etc/sssd/sssd.conf</code></p>

<pre><code class="language-ini">...
[domain/lime.lan]
...
fallback_homedir = /home/%u
use_fully_qualified_names = False
...
</code></pre>

<h4>Verify LDAP synchs Users/Groups with AD</h4>

<pre><code class="language-bash">â˜© ssh a0
...
u1@a0 [10:33:32] [1] [#0] ~
â˜© groups
u1 wheel domain users linux-users linux-sudoers
</code></pre>

<p>If auth fails, check service logs</p>

<pre><code class="language-bash">sudo journalctl -u sssd -f
sudo tail -f /var/log/secure
</code></pre>

<h3>Verify Kerberos</h3>

<p>@ <code>u1@a0</code></p>

<pre><code class="language-bash">u1@a0 [08:05:27] [1] [#0] ~
â˜© kinit admin@LIME.LAN
Password for admin@LIME.LAN:

u1@a0 [08:06:40] [1] [#0] ~
â˜© klist
Ticket cache: KCM:1000
Default principal: admin@LIME.LAN

Valid starting     Expires            Service principal
03/02/25 08:06:36  03/02/25 18:06:36  krbtgt/LIME.LAN@LIME.LAN
        renew until 03/09/25 09:06:14
</code></pre>

<pre><code class="language-bash">â˜© kinit u1@LIME.LAN
Password for u1@LIME.LAN:

â˜© klist
Ticket cache: KCM:1000:28381
Default principal: u1@LIME.LAN

Valid starting     Expires            Service principal
03/02/25 08:11:22  03/02/25 18:11:22  krbtgt/LIME.LAN@LIME.LAN
        renew until 03/09/25 09:11:17

â˜© klist -l
Principal name                 Cache name
--------------                 ----------
u1@LIME.LAN                    KCM:1000:28381
admin@LIME.LAN                 KCM:1000
</code></pre>

<pre><code class="language-bash">â˜© utc;utco;utcz;gmt
2025-03-02T08:17:57 [EST]
2025-03-02T08:17:57-0500
2025-03-02T13:17:57Z
2025-03-02T13:17:57Z
</code></pre>

<h3>SSH Auth using PKI</h3>

<p>Now setup PKI for key-based authentication</p>

<pre><code class="language-bash"># Generate key pair
ssh-keygen -t ecdsa -C admin@lime.lan -f ~/.ssh/dc1_admin
# Push key to target host
ssh-copy-id -i ~/.ssh/dc1_admin admin@a0.lime.lan
# Configure
vi ~/.ssh/config
</code></pre>

<pre><code class="language-ini">Host admin
    Hostname 192.168.11.103
    User admin
    IdentityFile ~/.ssh/dc1_admin
</code></pre>

<p>Test/Verify</p>

<pre><code class="language-bash">Ubuntu [18:34:30] [1] [#0] ~
â˜© ssh admin
...
[admin@a0 ~]$ 

</code></pre>

<h3>Fix SELinux objects</h3>

<pre><code class="language-bash"># View current
â˜© id -Z
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

# Fix
â˜© sudo semanage login -a -s sysadm_u 'admin@lime.lan'
</code></pre>

<p>Verify after logout/in</p>

<pre><code class="language-bash"># View current (fixed)
â˜© id -Z
staff_u:staff_r:staff_t:s0-s0:c0.c1023
</code></pre>

<h3><a href="https://chatgpt.com/share/679e5087-0d8c-8009-949a-c328ff4b5c02">Login Lockout v. Sudo (Non-)Lockout</a></h3>

<p>@ <strong><code>/etc/pam.d/sudo</code></strong></p>

<pre><code class="language-ini">#%PAM-1.0
auth       include      system-auth
account    include      system-auth
password   include      system-auth
session    include      system-auth
</code></pre>

<p>@ <strong><code>/etc/pam.d/system-auth</code></strong></p>

<pre><code class="language-ini">auth     required  pam_faillock.so preauth silent audit deny=3 unlock_time=600
auth     required  pam_faillock.so authfail audit deny=3 unlock_time=600
</code></pre>

<h2>AD Certificate Services (AD CS)</h2>

<p>See snapshots of the GUI</p>

<ol>
<li>Open <strong>Server Manager</strong>.</li>
<li>Click <strong>Manage</strong> and select <strong>Add Roles and Features</strong>.</li>
<li>In the <strong>Add Roles and Features Wizard</strong>:

<ul>
<li>Active Directory Certificate Services : Roles (checkboxes):

<ul>
<li>Certificate Authority</li>
<li>Certificate Authority Web Enrollment

<ul>
<li>CA name (checkbox)</li>
<li>Target CA: <code>dc1.lime.lan\lime-DC1-CA</code></li>
</ul></li>
<li>Certificate Enrollment Web Service (CES)

<ul>
<li>Type: Client certificate authentication</li>
</ul></li>
<li>Server Certificate

<ul>
<li>Specify a Server Authentication Certificate

<ul>
<li>Choose an existing certificate for SSL encryption

<ul>
<li><code>dc1.lime.lan</code> (One year expiry)</li>
</ul></li>
</ul></li>
</ul></li>
<li>Add the designated ADCS (web service) <code>User</code> (<code>Administrator</code>) to <code>Group</code> <code>IIS_IUSRS</code>

<ul>
<li>The certificate server is protected by ADDS

<ul>
<li>Authenticate at: <a href="https://dc1.lime.lan/certsrv/">https://dc1.lime.lan/certsrv/</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Save the Root CA certificate</strong>

<ul>
<li>Open Certification Authority GUI (<code>crtsrv</code>)

<ul>
<li><strong>Right-click on the certificate</strong> (<code>dc1.lime.lan</code>)</li>
<li>Open

<ul>
<li>Details : &quot;Copy to File&quot; (button) : Next :

<ul>
<li>&quot;<strong>Base-64 encoded X.509 (.CER)</strong>&quot; (checkbox) : Next ... Save file.

<ul>
<li>E.g., <code>ca-root-dc1.lime.lan.cer</code></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Import the Root CA certficate</strong> into host(s) and/or client(s) trust store,
so that the IIS-served TLS certificate of <strong>Certificate Services</strong> web page will validate.

<ul>
<li>@ Windows 11, open <code>certlm.msc</code> and import to &quot;<strong>Trusted Root Certification Authorities</strong>&quot; folder.</li>
</ul></li>
</ol>

<h3>Root CA certificate</h3>

<p>Save the root CA certificate using PowerShell</p>

<pre><code class="language-powershell">$caName     = &quot;lime-DC1-CA&quot;
$filePath   = &quot;ca-root-dc1.lime.lan.cer&quot;
$cert       = Get-ADObject -LDAPFilter &quot;(cn=$caName)&quot; -SearchBase &quot;CN=Certification Authorities,CN=Public Key Services,CN=Services,$((Get-ADRootDSE).configurationNamingContext)&quot; -Properties &quot;cACertificate&quot;
[System.IO.File]::WriteAllBytes($filePath, $cert.&quot;cACertificate&quot;[0])

</code></pre>

<h3>Obtain a TLS certificate  via CSR</h3>

<h4>@ <a href="https://dc1.lime.lan/certsrv/">https://dc1.lime.lan/certsrv/</a></h4>

<ol>
<li>Authenticate (against ADDS) by Username/Password

<ul>
<li>Administrator

<ul>
<li><code>User</code> must be member of <code>Group</code> <code>IIS_IUSRS</code></li>
</ul></li>
</ul></li>
<li><strong>Request a certificate</strong>

<ul>
<li>... submit an <a href="#hyperlink-mock"><strong>advanced certificate request</strong></a></li>
</ul></li>
<li><strong>Submit a Certificate Request</strong> or Renewal Request

<ul>
<li><strong>Saved Request</strong> (HTML FORM : text input box):

<ul>
<li>Paste the <strong>CSR</strong> of <strong>PKCS#10</strong> (New) / PKCS#7 (Renewal) <strong>format</strong></li>
</ul></li>
<li><strong>Certificate Template</strong>:

<ul>
<li><strong>Web Server</strong> (dropdown)</li>
</ul></li>
<li>Additional Attributes (text input box):

<ul>
<li>Leave blank</li>
</ul></li>
</ul></li>
<li>Submit (button)</li>
</ol>

<h4>CSR</h4>

<p>AD CS requires CSR in PKCS#10/#7 (New/Renew) format.
OpenSSL generates the request (<code>*.csr</code>) in that format by default.</p>

<p>Regarding Windows Server 2019 and prior,
AD CS offers <strong>only RSA-based certificates</strong>
unless that role is configured otherwise,
which is a non-trivial task that nearly no organization performs.</p>

<pre><code class="language-bash">root=lime.lan
cn=kube.$root
TLS_ST=MD
TLS_L=AAC
TLS_O=DisselTree
TLS_OU=ops
## Create the configuration file (CNF) : See man config
## See: man openssl-req : CONFIGURATION FILE FORMAT section
## https://www.openssl.org/docs/man1.0.2/man1/openssl-req.html
cat &lt;&lt;-EOH |tee $cn.cnf
[ req ]
prompt              = no        # Disable interactive prompts.
default_bits        = 2048      # Key size for RSA keys. Ignored for Ed25519.
default_md          = sha256    # Hashing algorithm.
distinguished_name  = req_distinguished_name 
req_extensions      = v3_req    # Extensions to include in the request.
[ req_distinguished_name ] 
CN              = $cn                   # Common Name
C               = ${TLS_C:-US}          # Country
ST              = ${TLS_ST:-NY}         # State or Province
L               = ${TLS_L:-Gotham}      # Locality name
O               = ${TLS_O:-Foobar Inc}  # Organization name
OU              = ${TLS_OU:-GitOps}     # Organizational Unit name
emailAddress    = admin@$root 
[ v3_req ]
subjectAltName      = @alt_names
keyUsage            = digitalSignature
extendedKeyUsage    = serverAuth
[ alt_names ]
DNS.1 = $cn
DNS.2 = *.$cn   # Wildcard. CA must allow, else declare each subdomain.
EOH

# RSA
openssl req -new -noenc -config $cn.cnf -extensions v3_req -newkey rsa:2048 -keyout $cn.key -out $cn.csr 
# ED25519
openssl req -new -noenc -config $cn.cnf -extensions v3_req -newkey ed25519 -keyout $cn.key -out $cn.csr
# ECDSA (NIST P-256 curve)
openssl req -new -noenc -config $cn.cnf -extensions v3_req -newkey ec:&lt;(openssl ecparam -name prime256v1 -genkey) -keyout $cn.key -out $cn.csr
</code></pre>

<p>Request the TLS certificate using the HTML FORM of Windows AD CS web server at <a href="https://dc1.lime.lan/certsrv/">https://dc1.lime.lan/certsrv/</a> .
The response has both full-chain and end-entity certificates encoded in PKCS#7 and having DER (binary) format.</p>

<ul>
<li><p><code>certnew.p7b</code></p>

<pre><code class="language-bash">
# Convert certificate from PKCS#7 (.p7b) to PEM format
cn=kube.lime.lan
openssl pkcs7 -print_certs -in certnew.p7b -out $cn.crt

# Parse the certificate
openssl x509 -noout -issuer -subject -startdate -enddate -ext subjectAltName -in $cn.crt
</code></pre>

<pre><code class="language-plaintext">issuer=DC = lan, DC = lime, CN = lime-DC1-CA
subject=C = US, ST = MD, L = AAC, O = DisselTree, OU = ops, CN = kube.lime.lan, emailAddress = admin@lime.lan
notBefore=Jan 25 14:32:36 2025 GMT
notAfter=Jan 25 14:32:36 2027 GMT
X509v3 Subject Alternative Name:
DNS:kube.lime.lan, DNS:*.kube.lime.lan
</code></pre></li>

<li><p>Note root CA is <code>lime-DC1-CA</code></p></li>
</ul>

<h3>&nbsp;</h3>
 
    </main>

    <script src="https://sempernow.github.io/refpages/sa/js/base.js"></script>
    <script>
        ;(function(o, undefined){
            'use strict'
            window.addEventListener('load', () => {
                ;(() => {})//()
                ;(() => {})//()
                ;(() => { // FOO LAB
                    const log = o.log('foo')
                        ,main = o.css('MAIN')
                    log('foo')
                    o.toDOM(main, '<h1>TEST</h1>')
                })//()
            })
        })( (typeof window !== 'undefined') 
            && (window[__APP__] = window[__APP__] || {})
                || (typeof global !== 'undefined') 
                    && (global[__APP__] = global[__APP__] || {})
        );
    </script>
</body>
</html>
